"use strict";
/**
 * Created by user on 2018/8/13/013.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const normalize_1 = require("@node-novel/normalize");
const array_hyper_unique_1 = require("array-hyper-unique");
const BluebirdPromise = require("bluebird");
const fs = require("fs-extra");
const novelGlobby = require("node-novel-globby/g");
const glob_sort_1 = require("node-novel-globby/lib/glob-sort");
const util_1 = require("./lib/util");
exports.md_href = util_1.md_href;
exports.md_link_escape = util_1.md_link_escape;
const path = require("upath2");
function processTocContents(basePath, outputFile, fnHeader = makeHeader) {
    return getList(basePath)
        .then(function (ls) {
        return glob_sort_1.sortTree(ls);
    })
        .then(async function (ls) {
        if (!ls.length) {
            return '';
        }
        let lastTop;
        let lastTop2;
        return ls.reduce(function (a, b) {
            let c = b.split('/');
            let nowTop = c[0];
            if (nowTop != lastTop) {
                let md = makeLink(nowTop, c[0], true);
                a.push(`\n\n## ${md}\n`);
                lastTop2 = undefined;
            }
            let nowFile;
            if (c.length > 2) {
                let nowTop2 = c[1];
                if (nowTop2 != lastTop2) {
                    let md = makeLink(nowTop2, c.slice(0, 2).join('/'), true);
                    a.push(`\n### ${md}\n`);
                }
                lastTop2 = nowTop2;
                nowFile = c[2];
            }
            else {
                nowFile = c[1];
            }
            let md = makeLink(nowFile, b);
            a.push(`- ${md}`);
            lastTop = nowTop;
            return a;
            // @ts-ignore
        }, await fnHeader(basePath)).join("\n") + "\n\n";
    })
        .tap(function (ls) {
        if (ls && outputFile) {
            return fs.outputFile(outputFile, ls);
        }
    });
}
exports.processTocContents = processTocContents;
function makeHeaderAsync(basePath, ...argv) {
    return BluebirdPromise.resolve(makeHeader(basePath));
}
exports.makeHeaderAsync = makeHeaderAsync;
function makeHeader(basePath, ...argv) {
    let titles = [
        path.basename(basePath),
    ];
    let meta = util_1.loadReadmeMetaSync(path.join(basePath, 'README.md'));
    if (meta && meta.novel) {
        let arr = util_1.getNovelTitles(meta);
        if (arr.length) {
            titles = array_hyper_unique_1.array_unique(titles.concat(arr));
        }
    }
    let arr = [
        `# CONTENTS\n`,
        titles.join('  \n'),
    ];
    let _appended = [];
    let _path;
    _path = 'README.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`README.md`, _path);
        _appended.push(`- ${md} - 簡介與其他資料`);
    }
    _path = '譯名對照.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`譯名對照`, _path);
        _appended.push(`- ${md}`);
    }
    _path = '整合樣式.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`整合樣式`, _path);
        _appended.push(`- ${md}`);
    }
    _path = 'ja.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`含有原文的章節`, _path);
        _appended.push(`- ${md} - 可能為未翻譯或者吞樓，等待圖轉文之類`);
    }
    _path = '待修正屏蔽字.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`待修正屏蔽字`, _path);
        _appended.push(`- ${md} - 需要有人協助將 \`**\` 內的字補上`);
    }
    if (_appended.length) {
        arr.push("\n");
        arr.push(..._appended);
    }
    return arr;
}
exports.makeHeader = makeHeader;
function makeLink(title, link, isDir) {
    let t = normalize_1.normalize_strip(title, isDir);
    if (!isDir) {
        t = path.basename(t, '.txt');
    }
    t = util_1.md_link_escape(t);
    return `[${t}](${util_1.md_href(link)})`;
}
exports.makeLink = makeLink;
function getList(basePath) {
    return novelGlobby.globbyASync([
        '**/*.txt',
    ], {
        cwd: basePath,
        throwEmpty: false,
    });
}
exports.getList = getList;
exports.default = processTocContents;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9jX2NvbnRlbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidG9jX2NvbnRlbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCxxREFBd0Q7QUFDeEQsMkRBQWtEO0FBQ2xELDRDQUE0QztBQUM1QywrQkFBK0I7QUFDL0IsbURBQW1EO0FBQ25ELCtEQUEyRDtBQUMzRCxxQ0FBeUY7QUFFaEYsa0JBRm9DLGNBQU8sQ0FFcEM7QUFBRSx5QkFGb0MscUJBQWMsQ0FFcEM7QUFEaEMsK0JBQWdDO0FBaUJoQyxTQUFnQixrQkFBa0IsQ0FBQyxRQUFnQixFQUFFLFVBQW1CLEVBQUUsV0FBc0IsVUFBVTtJQUV6RyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRTtRQUVqQixPQUFPLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDcEIsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLEtBQUssV0FBVyxFQUFFO1FBRXZCLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUNkO1lBQ0MsT0FBTyxFQUFFLENBQUM7U0FDVjtRQUVELElBQUksT0FBZSxDQUFDO1FBQ3BCLElBQUksUUFBZ0IsQ0FBQztRQUVyQixPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUU5QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRXJCLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVsQixJQUFJLE1BQU0sSUFBSSxPQUFPLEVBQ3JCO2dCQUNDLElBQUksRUFBRSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUV0QyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFFekIsUUFB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Q0FBQyxDQUFDO1FBQ2YsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFDO0tBQ3ZCO0lBRUQsT0FBTyxHQUFHLENBQUM7QUFDWixDQUFDO0FBaEZELGdDQWdGQztBQUVELFNBQWdCLFFBQVEsQ0FBQyxLQUFhLEVBQUUsSUFBWSxFQUFFLEtBQWU7SUFFcEUsSUFBSSxDQUFDLEdBQUcsMkJBQWUsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFdEMsSUFBSSxDQUFDLEtBQUssRUFDVjtRQUNDLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztLQUM3QjtJQUVELENBQUMsR0FBRyxxQkFBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXRCLE9BQU8sSUFBSSxDQUFDLEtBQUssY0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUE7QUFDbEMsQ0FBQztBQVpELDRCQVlDO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLFFBQWdCO0lBRXZDLE9BQU8sV0FBVyxDQUFDLFdBQVcsQ0FBQztRQUM5QixVQUFVO0tBQ1YsRUFBRTtRQUNGLEdBQUcsRUFBRSxRQUFRO1FBQ2IsVUFBVSxFQUFFLEtBQUs7S0FDakIsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQVJELDBCQVFDO0FBRUQsa0JBQWUsa0JBQWtCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzgvMTMvMDEzLlxuICovXG5cbmltcG9ydCB7IG5vcm1hbGl6ZV9zdHJpcCB9IGZyb20gJ0Bub2RlLW5vdmVsL25vcm1hbGl6ZSc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUgfSBmcm9tICdhcnJheS1oeXBlci11bmlxdWUnO1xuaW1wb3J0ICogYXMgQmx1ZWJpcmRQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIG5vdmVsR2xvYmJ5IGZyb20gJ25vZGUtbm92ZWwtZ2xvYmJ5L2cnO1xuaW1wb3J0IHsgc29ydFRyZWUgfSBmcm9tICdub2RlLW5vdmVsLWdsb2JieS9saWIvZ2xvYi1zb3J0JztcbmltcG9ydCB7IGdldE5vdmVsVGl0bGVzLCBsb2FkUmVhZG1lTWV0YVN5bmMsIG1kX2hyZWYsIG1kX2xpbmtfZXNjYXBlIH0gZnJvbSAnLi9saWIvdXRpbCc7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuZXhwb3J0IHsgbWRfaHJlZiwgbWRfbGlua19lc2NhcGUgfVxuXG4vKlxucHJvY2Vzc1RvY0NvbnRlbnRzKCdEOi9Vc2Vycy9Eb2N1bWVudHMvVGhlIFByb2plY3Qvbm9kZWpzLXRlc3Qvbm9kZS1ub3ZlbDIvZGlzdF9ub3ZlbC91c2VyL+ixmuWFrOeIteOBq+i7oueUn+OBl+OBn+OBi+OCieOAgeS7iuW6puOBr+WQm+OBq+WlveOBjeOBqOiogOOBhOOBn+OBhCcsICcuL3Rlc3QvdGVtcC8xMjMudHh0Jylcblx0LnRhcChmdW5jdGlvbiAobHMpXG5cdHtcblx0XHRjb25zb2xlLmxvZyhscyk7XG5cdH0pXG47XG4qL1xuXG5leHBvcnQgdHlwZSBJRm5IZWFkZXIgPSB0eXBlb2YgbWFrZUhlYWRlclxuXHR8IHR5cGVvZiBtYWtlSGVhZGVyQXN5bmNcblx0fCBhbnlcblx0O1xuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc1RvY0NvbnRlbnRzKGJhc2VQYXRoOiBzdHJpbmcsIG91dHB1dEZpbGU/OiBzdHJpbmcsIGZuSGVhZGVyOiBJRm5IZWFkZXIgPSBtYWtlSGVhZGVyKVxue1xuXHRyZXR1cm4gZ2V0TGlzdChiYXNlUGF0aClcblx0XHQudGhlbihmdW5jdGlvbiAobHMpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHNvcnRUcmVlKGxzKVxuXHRcdH0pXG5cdFx0LnRoZW4oYXN5bmMgZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdGlmICghbHMubGVuZ3RoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gJyc7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBsYXN0VG9wOiBzdHJpbmc7XG5cdFx0XHRsZXQgbGFzdFRvcDI6IHN0cmluZztcblxuXHRcdFx0cmV0dXJuIGxzLnJlZHVjZShmdW5jdGlvbiAoYSwgYilcblx0XHRcdHtcblx0XHRcdFx0bGV0IGMgPSBiLnNwbGl0KCcvJyk7XG5cblx0XHRcdFx0bGV0IG5vd1RvcCA9IGNbMF07XG5cblx0XHRcdFx0aWYgKG5vd1RvcCAhPSBsYXN0VG9wKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IG1kID0gbWFrZUxpbmsobm93VG9wLCBjWzBdLCB0cnVlKTtcblxuXHRcdFx0XHRcdGEucHVzaChgXFxuXFxuIyMgJHttZH1cXG5gKTtcblxuXHRcdFx0XHRcdGxhc3RUb3AyID0gdW5kZWZpbmVkXG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgbm93RmlsZTogc3RyaW5nO1xuXG5cdFx0XHRcdGlmIChjLmxlbmd0aCA+IDIpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgbm93VG9wMiA9IGNbMV07XG5cblx0XHRcdFx0XHRpZiAobm93VG9wMiAhPSBsYXN0VG9wMilcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsZXQgbWQgPSBtYWtlTGluayhub3dUb3AyLCBjLnNsaWNlKDAsIDIpLmpvaW4oJy8nKSwgdHJ1ZSk7XG5cblx0XHRcdFx0XHRcdGEucHVzaChgXFxuIyMjICR7bWR9XFxuYCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0bGFzdFRvcDIgPSBub3dUb3AyO1xuXG5cdFx0XHRcdFx0bm93RmlsZSA9IGNbMl07XG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bm93RmlsZSA9IGNbMV07XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgbWQgPSBtYWtlTGluayhub3dGaWxlLCBiKTtcblxuXHRcdFx0XHRhLnB1c2goYC0gJHttZH1gKTtcblxuXHRcdFx0XHRsYXN0VG9wID0gbm93VG9wO1xuXG5cdFx0XHRcdHJldHVybiBhO1xuXHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHR9LCBhd2FpdCBmbkhlYWRlcihiYXNlUGF0aCkpLmpvaW4oXCJcXG5cIikgKyBcIlxcblxcblwiXG5cdFx0fSlcblx0XHQudGFwKGZ1bmN0aW9uIChscylcblx0XHR7XG5cdFx0XHRpZiAobHMgJiYgb3V0cHV0RmlsZSlcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIGZzLm91dHB1dEZpbGUob3V0cHV0RmlsZSwgbHMpO1xuXHRcdFx0fVxuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZUhlYWRlckFzeW5jKGJhc2VQYXRoOiBzdHJpbmcsIC4uLmFyZ3YpXG57XG5cdHJldHVybiBCbHVlYmlyZFByb21pc2UucmVzb2x2ZShtYWtlSGVhZGVyKGJhc2VQYXRoKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VIZWFkZXIoYmFzZVBhdGg6IHN0cmluZywgLi4uYXJndilcbntcblxuXHRsZXQgdGl0bGVzOiBzdHJpbmdbXSA9IFtcblx0XHRwYXRoLmJhc2VuYW1lKGJhc2VQYXRoKSxcblx0XTtcblxuXHRsZXQgbWV0YSA9IGxvYWRSZWFkbWVNZXRhU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsICdSRUFETUUubWQnKSk7XG5cblx0aWYgKG1ldGEgJiYgbWV0YS5ub3ZlbClcblx0e1xuXHRcdGxldCBhcnIgPSBnZXROb3ZlbFRpdGxlcyhtZXRhKTtcblxuXHRcdGlmIChhcnIubGVuZ3RoKVxuXHRcdHtcblx0XHRcdHRpdGxlcyA9IGFycmF5X3VuaXF1ZSh0aXRsZXMuY29uY2F0KGFycikpO1xuXHRcdH1cblx0fVxuXG5cdGxldCBhcnIgPSBbXG5cdFx0YCMgQ09OVEVOVFNcXG5gLFxuXHRcdHRpdGxlcy5qb2luKCcgIFxcbicpLFxuXHRdO1xuXG5cdGxldCBfYXBwZW5kZWQgPSBbXTtcblxuXHRsZXQgX3BhdGg6IHN0cmluZztcblxuXHRfcGF0aCA9ICdSRUFETUUubWQnO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0e1xuXHRcdGxldCBtZCA9IG1ha2VMaW5rKGBSRUFETUUubWRgLCBfcGF0aCk7XG5cblx0XHRfYXBwZW5kZWQucHVzaChgLSAke21kfSAtIOewoeS7i+iIh+WFtuS7luizh+aWmWApXG5cdH1cblxuXHRfcGF0aCA9ICfora/lkI3lsI3nhacubWQnO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0e1xuXHRcdGxldCBtZCA9IG1ha2VMaW5rKGDora/lkI3lsI3nhadgLCBfcGF0aCk7XG5cblx0XHRfYXBwZW5kZWQucHVzaChgLSAke21kfWApXG5cdH1cblxuXHRfcGF0aCA9ICfmlbTlkIjmqKPlvI8ubWQnO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0e1xuXHRcdGxldCBtZCA9IG1ha2VMaW5rKGDmlbTlkIjmqKPlvI9gLCBfcGF0aCk7XG5cblx0XHRfYXBwZW5kZWQucHVzaChgLSAke21kfWApXG5cdH1cblxuXHRfcGF0aCA9ICdqYS5tZCc7XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHR7XG5cdFx0bGV0IG1kID0gbWFrZUxpbmsoYOWQq+acieWOn+aWh+eahOeroOevgGAsIF9wYXRoKTtcblxuXHRcdF9hcHBlbmRlZC5wdXNoKGAtICR7bWR9IC0g5Y+v6IO954K65pyq57+76K2v5oiW6ICF5ZCe5qiT77yM562J5b6F5ZyW6L2J5paH5LmL6aGeYClcblx0fVxuXG5cdF9wYXRoID0gJ+W+heS/ruato+Wxj+iUveWtly5tZCc7XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHR7XG5cdFx0bGV0IG1kID0gbWFrZUxpbmsoYOW+heS/ruato+Wxj+iUveWtl2AsIF9wYXRoKTtcblxuXHRcdF9hcHBlbmRlZC5wdXNoKGAtICR7bWR9IC0g6ZyA6KaB5pyJ5Lq65Y2U5Yqp5bCHIFxcYCoqXFxgIOWFp+eahOWtl+ijnOS4imApO1xuXHR9XG5cblx0aWYgKF9hcHBlbmRlZC5sZW5ndGgpXG5cdHtcblx0XHRhcnIucHVzaChcIlxcblwiKTtcblx0XHRhcnIucHVzaCguLi5fYXBwZW5kZWQpO1xuXHR9XG5cblx0cmV0dXJuIGFycjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VMaW5rKHRpdGxlOiBzdHJpbmcsIGxpbms6IHN0cmluZywgaXNEaXI/OiBib29sZWFuKVxue1xuXHRsZXQgdCA9IG5vcm1hbGl6ZV9zdHJpcCh0aXRsZSwgaXNEaXIpO1xuXG5cdGlmICghaXNEaXIpXG5cdHtcblx0XHR0ID0gcGF0aC5iYXNlbmFtZSh0LCAnLnR4dCcpO1xuXHR9XG5cblx0dCA9IG1kX2xpbmtfZXNjYXBlKHQpO1xuXG5cdHJldHVybiBgWyR7dH1dKCR7bWRfaHJlZihsaW5rKX0pYFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TGlzdChiYXNlUGF0aDogc3RyaW5nKVxue1xuXHRyZXR1cm4gbm92ZWxHbG9iYnkuZ2xvYmJ5QVN5bmMoW1xuXHRcdCcqKi8qLnR4dCcsXG5cdF0sIHtcblx0XHRjd2Q6IGJhc2VQYXRoLFxuXHRcdHRocm93RW1wdHk6IGZhbHNlLFxuXHR9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBwcm9jZXNzVG9jQ29udGVudHNcbiJdfQ==