"use strict";
/**
 * Created by user on 2018/8/13/013.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const BluebirdPromise = require("bluebird");
const path = require("upath2");
const fs = require("fs-extra");
const array_hyper_unique_1 = require("array-hyper-unique");
const index_1 = require("./index");
const novelGlobby = require("node-novel-globby/g");
const glob_sort_1 = require("node-novel-globby/lib/glob-sort");
const normalize_1 = require("@node-novel/normalize");
const util_1 = require("./lib/util");
function processTocContents(basePath, outputFile, fnHeader = makeHeader) {
    return getList(basePath)
        .then(function (ls) {
        return glob_sort_1.sortTree(ls);
    })
        .then(async function (ls) {
        if (!ls.length) {
            return '';
        }
        let lastTop;
        let lastTop2;
        return ls.reduce(function (a, b) {
            let c = b.split('/');
            let nowTop = c[0];
            if (nowTop != lastTop) {
                let md = makeLink(nowTop, c[0], true);
                a.push(`\n\n## ${md}\n`);
                lastTop2 = undefined;
            }
            let nowFile;
            if (c.length > 2) {
                let nowTop2 = c[1];
                if (nowTop2 != lastTop2) {
                    let md = makeLink(nowTop2, c.slice(0, 2).join('/'), true);
                    a.push(`\n### ${md}\n`);
                }
                lastTop2 = nowTop2;
                nowFile = c[2];
            }
            else {
                nowFile = c[1];
            }
            let md = makeLink(nowFile, b);
            a.push(`- ${md}`);
            lastTop = nowTop;
            return a;
            // @ts-ignore
        }, await fnHeader(basePath)).join("\n") + "\n\n";
    })
        .tap(function (ls) {
        if (ls && outputFile) {
            return fs.outputFile(outputFile, ls);
        }
    });
}
exports.processTocContents = processTocContents;
function makeHeaderAsync(basePath, ...argv) {
    return BluebirdPromise.resolve(makeHeader(basePath));
}
exports.makeHeaderAsync = makeHeaderAsync;
function makeHeader(basePath, ...argv) {
    let titles = [
        path.basename(basePath),
    ];
    let meta = util_1.loadReadmeMetaSync(path.join(basePath, 'README.md'));
    if (meta && meta.novel) {
        let arr = util_1.getNovelTitles(meta);
        if (arr.length) {
            titles = array_hyper_unique_1.array_unique(titles.concat(arr));
        }
    }
    let arr = [
        `# CONTENTS\n`,
        ...titles,
    ];
    let _appended = [];
    let _path;
    _path = 'README.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`README.md`, _path);
        _appended.push(`- ${md} - 簡介與其他資料`);
    }
    _path = '譯名對照.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`譯名對照`, _path);
        _appended.push(`- ${md}`);
    }
    _path = '整合樣式.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`整合樣式`, _path);
        _appended.push(`- ${md}`);
    }
    _path = 'ja.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`含有原文的章節`, _path);
        _appended.push(`- ${md} - 可能為未翻譯或者吞樓，等待圖轉文之類`);
    }
    _path = '待修正屏蔽字.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`待修正屏蔽字`, _path);
        _appended.push(`- ${md} - 需要有人協助將 \`**\` 內的字補上`);
    }
    if (_appended.length) {
        arr.push("\n");
        arr.push(..._appended);
    }
    return arr;
}
exports.makeHeader = makeHeader;
function makeLink(title, link, isDir) {
    let t = normalize_1.normalize_strip(title, isDir);
    if (!isDir) {
        t = path.basename(t, '.txt');
    }
    t = md_link_escape(t);
    return `[${t}](${index_1.md_href(link)})`;
}
exports.makeLink = makeLink;
function md_link_escape(text) {
    return text.replace(/[\[\]]/g, function (s) {
        return '\\' + s;
    });
}
exports.md_link_escape = md_link_escape;
function getList(basePath) {
    return novelGlobby.globbyASync([
        '**/*.txt',
    ], {
        cwd: basePath,
        throwEmpty: false,
    });
}
exports.getList = getList;
exports.default = processTocContents;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9jX2NvbnRlbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidG9jX2NvbnRlbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCw0Q0FBNEM7QUFFNUMsK0JBQWdDO0FBQ2hDLCtCQUErQjtBQUUvQiwyREFBa0Q7QUFFbEQsbUNBQTJDO0FBQzNDLG1EQUFtRDtBQUNuRCwrREFBMkQ7QUFDM0QscURBQXdEO0FBQ3hELHFDQUFnRjtBQWdCaEYsU0FBZ0Isa0JBQWtCLENBQUMsUUFBZ0IsRUFBRSxVQUFtQixFQUFFLFdBQXNCLFVBQVU7SUFFekcsT0FBTyxPQUFPLENBQUMsUUFBUSxDQUFDO1NBQ3RCLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFFakIsT0FBTyxvQkFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0lBQ3BCLENBQUMsQ0FBQztTQUNELElBQUksQ0FBQyxLQUFLLFdBQVcsRUFBRTtRQUV2QixJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFDZDtZQUNDLE9BQU8sRUFBRSxDQUFDO1NBQ1Y7UUFFRCxJQUFJLE9BQWUsQ0FBQztRQUNwQixJQUFJLFFBQWdCLENBQUM7UUFFckIsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7WUFFOUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVyQixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFbEIsSUFBSSxNQUFNLElBQUksT0FBTyxFQUNyQjtnQkFDQyxJQUFJLEVBQUUsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFFdEMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBRXpCLFFBQVEsR0FBRyxTQUFTLENBQUE7YUFDcEI7WUFFRCxJQUFJLE9B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QUN2QjtJQUVELE9BQU8sR0FBRyxDQUFDO0FBQ1osQ0FBQztBQWhGRCxnQ0FnRkM7QUFFRCxTQUFnQixRQUFRLENBQUMsS0FBYSxFQUFFLElBQVksRUFBRSxLQUFlO0lBRXBFLElBQUksQ0FBQyxHQUFHLDJCQUFlLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXRDLElBQUksQ0FBQyxLQUFLLEVBQ1Y7UUFDQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDN0I7SUFFRCxDQUFDLEdBQUcsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXRCLE9BQU8sSUFBSSxDQUFDLEtBQUssZUFBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUE7QUFDbEMsQ0FBQztBQVpELDRCQVlDO0FBRUQsU0FBZ0IsY0FBYyxDQUFDLElBQVk7SUFFMUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUM7UUFFekMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxDQUFDO0lBQ2pCLENBQUMsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQU5ELHdDQU1DO0FBRUQsU0FBZ0IsT0FBTyxDQUFDLFFBQWdCO0lBRXZDLE9BQU8sV0FBVyxDQUFDLFdBQVcsQ0FBQztRQUM5QixVQUFVO0tBQ1YsRUFBRTtRQUNGLEdBQUcsRUFBRSxRQUFRO1FBQ2IsVUFBVSxFQUFFLEtBQUs7S0FDakIsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQVJELDBCQVFDO0FBRUQsa0JBQWUsa0JBQWtCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE4LzgvMTMvMDEzLlxuICovXG5cbmltcG9ydCAqIGFzIEJsdWViaXJkUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgKiBhcyBGYXN0R2xvYiBmcm9tICdmYXN0LWdsb2InO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCd1cGF0aDInKTtcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCBub3ZlbEluZm8sIHsgbWRjb25mX3BhcnNlLCBJTWRjb25mTWV0YSwgc3RyaW5naWZ5LCBtZGNvbmYgfSBmcm9tICdub2RlLW5vdmVsLWluZm8nO1xuaW1wb3J0IHsgYXJyYXlfdW5pcXVlIH0gZnJvbSAnYXJyYXktaHlwZXItdW5pcXVlJztcbmltcG9ydCAqIGFzIHNvcnRPYmplY3RLZXlzIGZyb20gJ3NvcnQtb2JqZWN0LWtleXMyJztcbmltcG9ydCB7IGdldF9pZHMsIG1kX2hyZWYgfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCAqIGFzIG5vdmVsR2xvYmJ5IGZyb20gJ25vZGUtbm92ZWwtZ2xvYmJ5L2cnO1xuaW1wb3J0IHsgc29ydFRyZWUgfSBmcm9tICdub2RlLW5vdmVsLWdsb2JieS9saWIvZ2xvYi1zb3J0JztcbmltcG9ydCB7IG5vcm1hbGl6ZV9zdHJpcCB9IGZyb20gJ0Bub2RlLW5vdmVsL25vcm1hbGl6ZSc7XG5pbXBvcnQgeyBnZXROb3ZlbFRpdGxlcywgbG9hZFJlYWRtZU1ldGEsIGxvYWRSZWFkbWVNZXRhU3luYyB9IGZyb20gJy4vbGliL3V0aWwnO1xuXG4vKlxucHJvY2Vzc1RvY0NvbnRlbnRzKCdEOi9Vc2Vycy9Eb2N1bWVudHMvVGhlIFByb2plY3Qvbm9kZWpzLXRlc3Qvbm9kZS1ub3ZlbDIvZGlzdF9ub3ZlbC91c2VyL+ixmuWFrOeIteOBq+i7oueUn+OBl+OBn+OBi+OCieOAgeS7iuW6puOBr+WQm+OBq+WlveOBjeOBqOiogOOBhOOBn+OBhCcsICcuL3Rlc3QvdGVtcC8xMjMudHh0Jylcblx0LnRhcChmdW5jdGlvbiAobHMpXG5cdHtcblx0XHRjb25zb2xlLmxvZyhscyk7XG5cdH0pXG47XG4qL1xuXG5leHBvcnQgdHlwZSBJRm5IZWFkZXIgPSB0eXBlb2YgbWFrZUhlYWRlclxuXHR8IHR5cGVvZiBtYWtlSGVhZGVyQXN5bmNcblx0fCBhbnlcblx0O1xuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc1RvY0NvbnRlbnRzKGJhc2VQYXRoOiBzdHJpbmcsIG91dHB1dEZpbGU/OiBzdHJpbmcsIGZuSGVhZGVyOiBJRm5IZWFkZXIgPSBtYWtlSGVhZGVyKVxue1xuXHRyZXR1cm4gZ2V0TGlzdChiYXNlUGF0aClcblx0XHQudGhlbihmdW5jdGlvbiAobHMpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHNvcnRUcmVlKGxzKVxuXHRcdH0pXG5cdFx0LnRoZW4oYXN5bmMgZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdGlmICghbHMubGVuZ3RoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gJyc7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBsYXN0VG9wOiBzdHJpbmc7XG5cdFx0XHRsZXQgbGFzdFRvcDI6IHN0cmluZztcblxuXHRcdFx0cmV0dXJuIGxzLnJlZHVjZShmdW5jdGlvbiAoYSwgYilcblx0XHRcdHtcblx0XHRcdFx0bGV0IGMgPSBiLnNwbGl0KCcvJyk7XG5cblx0XHRcdFx0bGV0IG5vd1RvcCA9IGNbMF07XG5cblx0XHRcdFx0aWYgKG5vd1RvcCAhPSBsYXN0VG9wKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IG1kID0gbWFrZUxpbmsobm93VG9wLCBjWzBdLCB0cnVlKTtcblxuXHRcdFx0XHRcdGEucHVzaChgXFxuXFxuIyMgJHttZH1cXG5gKTtcblxuXHRcdFx0XHRcdGxhc3RUb3AyID0gdW5kZWZpbmVkXG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgbm93RmlsZTogc3RyaW5nO1xuXG5cdFx0XHRcdGlmIChjLmxlbmd0aCA+IDIpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgbm93VG9wMiA9IGNbMV07XG5cblx0XHRcdFx0XHRpZiAobm93VG9wMiAhPSBsYXN0VG9wMilcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsZXQgbWQgPSBtYWtlTGluayhub3dUb3AyLCBjLnNsaWNlKDAsIDIpLmpvaW4oJy8nKSwgdHJ1ZSk7XG5cblx0XHRcdFx0XHRcdGEucHVzaChgXFxuIyMjICR7bWR9XFxuYCk7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0bGFzdFRvcDIgPSBub3dUb3AyO1xuXG5cdFx0XHRcdFx0bm93RmlsZSA9IGNbMl07XG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bm93RmlsZSA9IGNbMV07XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsZXQgbWQgPSBtYWtlTGluayhub3dGaWxlLCBiKTtcblxuXHRcdFx0XHRhLnB1c2goYC0gJHttZH1gKTtcblxuXHRcdFx0XHRsYXN0VG9wID0gbm93VG9wO1xuXG5cdFx0XHRcdHJldHVybiBhO1xuXHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHR9LCBhd2FpdCBmbkhlYWRlcihiYXNlUGF0aCkpLmpvaW4oXCJcXG5cIikgKyBcIlxcblxcblwiXG5cdFx0fSlcblx0XHQudGFwKGZ1bmN0aW9uIChscylcblx0XHR7XG5cdFx0XHRpZiAobHMgJiYgb3V0cHV0RmlsZSlcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIGZzLm91dHB1dEZpbGUob3V0cHV0RmlsZSwgbHMpO1xuXHRcdFx0fVxuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWFrZUhlYWRlckFzeW5jKGJhc2VQYXRoOiBzdHJpbmcsIC4uLmFyZ3YpXG57XG5cdHJldHVybiBCbHVlYmlyZFByb21pc2UucmVzb2x2ZShtYWtlSGVhZGVyKGJhc2VQYXRoKSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VIZWFkZXIoYmFzZVBhdGg6IHN0cmluZywgLi4uYXJndilcbntcblxuXHRsZXQgdGl0bGVzOiBzdHJpbmdbXSA9IFtcblx0XHRwYXRoLmJhc2VuYW1lKGJhc2VQYXRoKSxcblx0XTtcblxuXHRsZXQgbWV0YSA9IGxvYWRSZWFkbWVNZXRhU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsICdSRUFETUUubWQnKSk7XG5cblx0aWYgKG1ldGEgJiYgbWV0YS5ub3ZlbClcblx0e1xuXHRcdGxldCBhcnIgPSBnZXROb3ZlbFRpdGxlcyhtZXRhKTtcblxuXHRcdGlmIChhcnIubGVuZ3RoKVxuXHRcdHtcblx0XHRcdHRpdGxlcyA9IGFycmF5X3VuaXF1ZSh0aXRsZXMuY29uY2F0KGFycikpO1xuXHRcdH1cblx0fVxuXG5cdGxldCBhcnIgPSBbXG5cdFx0YCMgQ09OVEVOVFNcXG5gLFxuXHRcdC4uLnRpdGxlcyxcblx0XTtcblxuXHRsZXQgX2FwcGVuZGVkID0gW107XG5cblx0bGV0IF9wYXRoOiBzdHJpbmc7XG5cblx0X3BhdGggPSAnUkVBRE1FLm1kJztcblxuXHRpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsIF9wYXRoKSkpXG5cdHtcblx0XHRsZXQgbWQgPSBtYWtlTGluayhgUkVBRE1FLm1kYCwgX3BhdGgpO1xuXG5cdFx0X2FwcGVuZGVkLnB1c2goYC0gJHttZH0gLSDnsKHku4voiIflhbbku5bos4fmlplgKVxuXHR9XG5cblx0X3BhdGggPSAn6K2v5ZCN5bCN54WnLm1kJztcblxuXHRpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsIF9wYXRoKSkpXG5cdHtcblx0XHRsZXQgbWQgPSBtYWtlTGluayhg6K2v5ZCN5bCN54WnYCwgX3BhdGgpO1xuXG5cdFx0X2FwcGVuZGVkLnB1c2goYC0gJHttZH1gKVxuXHR9XG5cblx0X3BhdGggPSAn5pW05ZCI5qij5byPLm1kJztcblxuXHRpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsIF9wYXRoKSkpXG5cdHtcblx0XHRsZXQgbWQgPSBtYWtlTGluayhg5pW05ZCI5qij5byPYCwgX3BhdGgpO1xuXG5cdFx0X2FwcGVuZGVkLnB1c2goYC0gJHttZH1gKVxuXHR9XG5cblx0X3BhdGggPSAnamEubWQnO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0e1xuXHRcdGxldCBtZCA9IG1ha2VMaW5rKGDlkKvmnInljp/mlofnmoTnq6Dnr4BgLCBfcGF0aCk7XG5cblx0XHRfYXBwZW5kZWQucHVzaChgLSAke21kfSAtIOWPr+iDveeCuuacque/u+itr+aIluiAheWQnuaok++8jOetieW+heWclui9ieaWh+S5i+mhnmApXG5cdH1cblxuXHRfcGF0aCA9ICflvoXkv67mraPlsY/olL3lrZcubWQnO1xuXG5cdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0e1xuXHRcdGxldCBtZCA9IG1ha2VMaW5rKGDlvoXkv67mraPlsY/olL3lrZdgLCBfcGF0aCk7XG5cblx0XHRfYXBwZW5kZWQucHVzaChgLSAke21kfSAtIOmcgOimgeacieS6uuWNlOWKqeWwhyBcXGAqKlxcYCDlhafnmoTlrZfoo5zkuIpgKTtcblx0fVxuXG5cdGlmIChfYXBwZW5kZWQubGVuZ3RoKVxuXHR7XG5cdFx0YXJyLnB1c2goXCJcXG5cIik7XG5cdFx0YXJyLnB1c2goLi4uX2FwcGVuZGVkKTtcblx0fVxuXG5cdHJldHVybiBhcnI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlTGluayh0aXRsZTogc3RyaW5nLCBsaW5rOiBzdHJpbmcsIGlzRGlyPzogYm9vbGVhbilcbntcblx0bGV0IHQgPSBub3JtYWxpemVfc3RyaXAodGl0bGUsIGlzRGlyKTtcblxuXHRpZiAoIWlzRGlyKVxuXHR7XG5cdFx0dCA9IHBhdGguYmFzZW5hbWUodCwgJy50eHQnKTtcblx0fVxuXG5cdHQgPSBtZF9saW5rX2VzY2FwZSh0KTtcblxuXHRyZXR1cm4gYFske3R9XSgke21kX2hyZWYobGluayl9KWBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1kX2xpbmtfZXNjYXBlKHRleHQ6IHN0cmluZylcbntcblx0cmV0dXJuIHRleHQucmVwbGFjZSgvW1xcW1xcXV0vZywgZnVuY3Rpb24gKHMpXG5cdHtcblx0XHRyZXR1cm4gJ1xcXFwnICsgcztcblx0fSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldExpc3QoYmFzZVBhdGg6IHN0cmluZylcbntcblx0cmV0dXJuIG5vdmVsR2xvYmJ5Lmdsb2JieUFTeW5jKFtcblx0XHQnKiovKi50eHQnLFxuXHRdLCB7XG5cdFx0Y3dkOiBiYXNlUGF0aCxcblx0XHR0aHJvd0VtcHR5OiBmYWxzZSxcblx0fSlcbn1cblxuZXhwb3J0IGRlZmF1bHQgcHJvY2Vzc1RvY0NvbnRlbnRzXG4iXX0=