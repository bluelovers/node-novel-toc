"use strict";
/**
 * Created by user on 2018/8/13/013.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const normalize_1 = require("@node-novel/normalize");
const array_hyper_unique_1 = require("array-hyper-unique");
const BluebirdPromise = require("bluebird");
const fs = require("fs-extra");
const novelGlobby = require("node-novel-globby/g");
const glob_sort_1 = require("node-novel-globby/lib/glob-sort");
const util_1 = require("./lib/util");
exports.md_href = util_1.md_href;
exports.md_link_escape = util_1.md_link_escape;
const path = require("upath2");
function processTocContents(basePath, outputFile, fnHeader = makeHeader) {
    return getList(basePath)
        .then(function (ls) {
        return glob_sort_1.sortTree(ls);
    })
        .then(async function (ls) {
        if (!ls.length) {
            return '';
        }
        let lastTop;
        let lastTop2;
        return ls.reduce(function (a, b) {
            let c = b.split('/');
            let nowTop = c[0];
            if (nowTop != lastTop) {
                let md = makeLink(nowTop, c[0], true);
                a.push(`\n\n## ${md}\n`);
                lastTop2 = undefined;
            }
            let nowFile;
            if (c.length > 2) {
                let nowTop2 = c[1];
                if (nowTop2 != lastTop2) {
                    let md = makeLink(nowTop2, c.slice(0, 2).join('/'), true);
                    a.push(`\n### ${md}\n`);
                }
                lastTop2 = nowTop2;
                nowFile = c[2];
            }
            else {
                nowFile = c[1];
            }
            let md = makeLink(nowFile, b);
            a.push(`- ${md}`);
            lastTop = nowTop;
            return a;
            // @ts-ignore
        }, await fnHeader(basePath)).join("\n") + "\n\n";
    })
        .tap(function (ls) {
        if (ls && outputFile) {
            return fs.outputFile(outputFile, ls);
        }
    });
}
exports.processTocContents = processTocContents;
function makeHeaderAsync(basePath, ...argv) {
    return BluebirdPromise.resolve(makeHeader(basePath));
}
exports.makeHeaderAsync = makeHeaderAsync;
function makeHeader(basePath, ...argv) {
    let titles = [
        path.basename(basePath),
    ];
    let meta = util_1.loadReadmeMetaSync(path.join(basePath, 'README.md'));
    if (meta && meta.novel) {
        let arr = util_1.getNovelTitles(meta);
        if (arr.length) {
            titles = array_hyper_unique_1.array_unique(titles.concat(arr));
        }
    }
    let arr = [
        `# CONTENTS\n`,
        titles.join('  \n'),
    ];
    let _appended = [];
    let _path;
    _path = 'README.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`README.md`, _path);
        _appended.push(`-  :closed_book: ${md} - 簡介與其他資料`);
    }
    {
        let _arr = [];
        _path = '譯名對照.md';
        if (fs.existsSync(path.join(basePath, _path))) {
            let md = makeLink(`譯名對照`, _path);
            _arr.push(`${md}`);
        }
        _path = '整合樣式.md';
        if (fs.existsSync(path.join(basePath, _path))) {
            let md = makeLink(`整合樣式`, _path);
            _arr.push(`${md}`);
        }
        if (_arr.length) {
            _appended.push(`-  :pencil: ${_arr.join(' ／ ')}`);
        }
    }
    _path = 'ja.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`含有原文的章節`, _path);
        _appended.push(`- ${md} - 可能為未翻譯或者吞樓，等待圖轉文之類`);
    }
    _path = '待修正屏蔽字.md';
    if (fs.existsSync(path.join(basePath, _path))) {
        let md = makeLink(`待修正屏蔽字`, _path);
        _appended.push(`- ${md} - 需要有人協助將 \`**\` 內的字補上`);
    }
    if (_appended.length) {
        arr.push("\n");
        arr.push(..._appended);
    }
    return arr;
}
exports.makeHeader = makeHeader;
function makeLink(title, link, isDir) {
    let t = normalize_1.normalize_strip(title, isDir);
    if (!isDir) {
        t = path.basename(t, '.txt');
    }
    t = util_1.md_link_escape(t);
    return `[${t}](${util_1.md_href(link)})`;
}
exports.makeLink = makeLink;
function getList(basePath) {
    return novelGlobby.globbyASync([
        '**/*.txt',
    ], {
        cwd: basePath,
        throwEmpty: false,
    });
}
exports.getList = getList;
exports.default = processTocContents;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9jX2NvbnRlbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidG9jX2NvbnRlbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFFSCxxREFBd0Q7QUFDeEQsMkRBQWtEO0FBQ2xELDRDQUE0QztBQUM1QywrQkFBK0I7QUFDL0IsbURBQW1EO0FBQ25ELCtEQUEyRDtBQUMzRCxxQ0FBeUY7QUFFaEYsa0JBRm9DLGNBQU8sQ0FFcEM7QUFBRSx5QkFGb0MscUJBQWMsQ0FFcEM7QUFEaEMsK0JBQWdDO0FBaUJoQyxTQUFnQixrQkFBa0IsQ0FBQyxRQUFnQixFQUFFLFVBQW1CLEVBQUUsV0FBc0IsVUFBVTtJQUV6RyxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRTtRQUVqQixPQUFPLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7SUFDcEIsQ0FBQyxDQUFDO1NBQ0QsSUFBSSxDQUFDLEtBQUssV0FBVyxFQUFFO1FBRXZCLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUNkO1lBQ0MsT0FBTyxFQUFFLENBQUM7U0FDVjtRQUVELElBQUksT0FBZSxDQUFDO1FBQ3BCLElBQUksUUFBZ0IsQ0FBQztRQUVyQixPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUU5QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRXJCLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVsQixJQUFJLE1BQU0sSUFBSSxPQUFPLEVBQ3JCO2dCQUNDLElBQUksRUFBRSxHQUFHLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUV0QyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFFekIsUUFB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QUFRLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRW5DLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLHlCQUF5QixDQUFDLENBQUM7S0FDakQ7SUFFRCxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQ3BCO1FBQ0MsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNmLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQztLQUN2QjtJQUVELE9BQU8sR0FBRyxDQUFDO0FBQ1osQ0FBQztBQXpGRCxnQ0F5RkM7QUFFRCxTQUFnQixRQUFRLENBQUMsS0FBYSxFQUFFLElBQVksRUFBRSxLQUFlO0lBRXBFLElBQUksQ0FBQyxHQUFHLDJCQUFlLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRXRDLElBQUksQ0FBQyxLQUFLLEVBQ1Y7UUFDQyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDN0I7SUFFRCxDQUFDLEdBQUcscUJBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV0QixPQUFPLElBQUksQ0FBQyxLQUFLLGNBQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFBO0FBQ2xDLENBQUM7QUFaRCw0QkFZQztBQUVELFNBQWdCLE9BQU8sQ0FBQyxRQUFnQjtJQUV2QyxPQUFPLFdBQVcsQ0FBQyxXQUFXLENBQUM7UUFDOUIsVUFBVTtLQUNWLEVBQUU7UUFDRixHQUFHLEVBQUUsUUFBUTtRQUNiLFVBQVUsRUFBRSxLQUFLO0tBQ2pCLENBQUMsQ0FBQTtBQUNILENBQUM7QUFSRCwwQkFRQztBQUVELGtCQUFlLGtCQUFrQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC84LzEzLzAxMy5cbiAqL1xuXG5pbXBvcnQgeyBub3JtYWxpemVfc3RyaXAgfSBmcm9tICdAbm9kZS1ub3ZlbC9ub3JtYWxpemUnO1xuaW1wb3J0IHsgYXJyYXlfdW5pcXVlIH0gZnJvbSAnYXJyYXktaHlwZXItdW5pcXVlJztcbmltcG9ydCAqIGFzIEJsdWViaXJkUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBub3ZlbEdsb2JieSBmcm9tICdub2RlLW5vdmVsLWdsb2JieS9nJztcbmltcG9ydCB7IHNvcnRUcmVlIH0gZnJvbSAnbm9kZS1ub3ZlbC1nbG9iYnkvbGliL2dsb2Itc29ydCc7XG5pbXBvcnQgeyBnZXROb3ZlbFRpdGxlcywgbG9hZFJlYWRtZU1ldGFTeW5jLCBtZF9ocmVmLCBtZF9saW5rX2VzY2FwZSB9IGZyb20gJy4vbGliL3V0aWwnO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCd1cGF0aDInKTtcbmV4cG9ydCB7IG1kX2hyZWYsIG1kX2xpbmtfZXNjYXBlIH1cblxuLypcbnByb2Nlc3NUb2NDb250ZW50cygnRDovVXNlcnMvRG9jdW1lbnRzL1RoZSBQcm9qZWN0L25vZGVqcy10ZXN0L25vZGUtbm92ZWwyL2Rpc3Rfbm92ZWwvdXNlci/osZrlhazniLXjgavou6LnlJ/jgZfjgZ/jgYvjgonjgIHku4rluqbjga/lkJvjgavlpb3jgY3jgajoqIDjgYTjgZ/jgYQnLCAnLi90ZXN0L3RlbXAvMTIzLnR4dCcpXG5cdC50YXAoZnVuY3Rpb24gKGxzKVxuXHR7XG5cdFx0Y29uc29sZS5sb2cobHMpO1xuXHR9KVxuO1xuKi9cblxuZXhwb3J0IHR5cGUgSUZuSGVhZGVyID0gdHlwZW9mIG1ha2VIZWFkZXJcblx0fCB0eXBlb2YgbWFrZUhlYWRlckFzeW5jXG5cdHwgYW55XG5cdDtcblxuZXhwb3J0IGZ1bmN0aW9uIHByb2Nlc3NUb2NDb250ZW50cyhiYXNlUGF0aDogc3RyaW5nLCBvdXRwdXRGaWxlPzogc3RyaW5nLCBmbkhlYWRlcjogSUZuSGVhZGVyID0gbWFrZUhlYWRlcilcbntcblx0cmV0dXJuIGdldExpc3QoYmFzZVBhdGgpXG5cdFx0LnRoZW4oZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdHJldHVybiBzb3J0VHJlZShscylcblx0XHR9KVxuXHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uIChscylcblx0XHR7XG5cdFx0XHRpZiAoIWxzLmxlbmd0aClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuICcnO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgbGFzdFRvcDogc3RyaW5nO1xuXHRcdFx0bGV0IGxhc3RUb3AyOiBzdHJpbmc7XG5cblx0XHRcdHJldHVybiBscy5yZWR1Y2UoZnVuY3Rpb24gKGEsIGIpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBjID0gYi5zcGxpdCgnLycpO1xuXG5cdFx0XHRcdGxldCBub3dUb3AgPSBjWzBdO1xuXG5cdFx0XHRcdGlmIChub3dUb3AgIT0gbGFzdFRvcClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBtZCA9IG1ha2VMaW5rKG5vd1RvcCwgY1swXSwgdHJ1ZSk7XG5cblx0XHRcdFx0XHRhLnB1c2goYFxcblxcbiMjICR7bWR9XFxuYCk7XG5cblx0XHRcdFx0XHRsYXN0VG9wMiA9IHVuZGVmaW5lZFxuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IG5vd0ZpbGU6IHN0cmluZztcblxuXHRcdFx0XHRpZiAoYy5sZW5ndGggPiAyKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IG5vd1RvcDIgPSBjWzFdO1xuXG5cdFx0XHRcdFx0aWYgKG5vd1RvcDIgIT0gbGFzdFRvcDIpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bGV0IG1kID0gbWFrZUxpbmsobm93VG9wMiwgYy5zbGljZSgwLCAyKS5qb2luKCcvJyksIHRydWUpO1xuXG5cdFx0XHRcdFx0XHRhLnB1c2goYFxcbiMjIyAke21kfVxcbmApO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGxhc3RUb3AyID0gbm93VG9wMjtcblxuXHRcdFx0XHRcdG5vd0ZpbGUgPSBjWzJdO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2Vcblx0XHRcdFx0e1xuXHRcdFx0XHRcdG5vd0ZpbGUgPSBjWzFdO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGV0IG1kID0gbWFrZUxpbmsobm93RmlsZSwgYik7XG5cblx0XHRcdFx0YS5wdXNoKGAtICR7bWR9YCk7XG5cblx0XHRcdFx0bGFzdFRvcCA9IG5vd1RvcDtcblxuXHRcdFx0XHRyZXR1cm4gYTtcblx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0fSwgYXdhaXQgZm5IZWFkZXIoYmFzZVBhdGgpKS5qb2luKFwiXFxuXCIpICsgXCJcXG5cXG5cIlxuXHRcdH0pXG5cdFx0LnRhcChmdW5jdGlvbiAobHMpXG5cdFx0e1xuXHRcdFx0aWYgKGxzICYmIG91dHB1dEZpbGUpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBmcy5vdXRwdXRGaWxlKG91dHB1dEZpbGUsIGxzKTtcblx0XHRcdH1cblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VIZWFkZXJBc3luYyhiYXNlUGF0aDogc3RyaW5nLCAuLi5hcmd2KVxue1xuXHRyZXR1cm4gQmx1ZWJpcmRQcm9taXNlLnJlc29sdmUobWFrZUhlYWRlcihiYXNlUGF0aCkpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtYWtlSGVhZGVyKGJhc2VQYXRoOiBzdHJpbmcsIC4uLmFyZ3YpXG57XG5cblx0bGV0IHRpdGxlczogc3RyaW5nW10gPSBbXG5cdFx0cGF0aC5iYXNlbmFtZShiYXNlUGF0aCksXG5cdF07XG5cblx0bGV0IG1ldGEgPSBsb2FkUmVhZG1lTWV0YVN5bmMocGF0aC5qb2luKGJhc2VQYXRoLCAnUkVBRE1FLm1kJykpO1xuXG5cdGlmIChtZXRhICYmIG1ldGEubm92ZWwpXG5cdHtcblx0XHRsZXQgYXJyID0gZ2V0Tm92ZWxUaXRsZXMobWV0YSk7XG5cblx0XHRpZiAoYXJyLmxlbmd0aClcblx0XHR7XG5cdFx0XHR0aXRsZXMgPSBhcnJheV91bmlxdWUodGl0bGVzLmNvbmNhdChhcnIpKTtcblx0XHR9XG5cdH1cblxuXHRsZXQgYXJyID0gW1xuXHRcdGAjIENPTlRFTlRTXFxuYCxcblx0XHR0aXRsZXMuam9pbignICBcXG4nKSxcblx0XTtcblxuXHRsZXQgX2FwcGVuZGVkID0gW107XG5cblx0bGV0IF9wYXRoOiBzdHJpbmc7XG5cblx0X3BhdGggPSAnUkVBRE1FLm1kJztcblxuXHRpZiAoZnMuZXhpc3RzU3luYyhwYXRoLmpvaW4oYmFzZVBhdGgsIF9wYXRoKSkpXG5cdHtcblx0XHRsZXQgbWQgPSBtYWtlTGluayhgUkVBRE1FLm1kYCwgX3BhdGgpO1xuXG5cdFx0X2FwcGVuZGVkLnB1c2goYC0gIDpjbG9zZWRfYm9vazogJHttZH0gLSDnsKHku4voiIflhbbku5bos4fmlplgKVxuXHR9XG5cblx0e1xuXHRcdGxldCBfYXJyOiBzdHJpbmdbXSA9IFtdO1xuXG5cdFx0X3BhdGggPSAn6K2v5ZCN5bCN54WnLm1kJztcblxuXHRcdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihiYXNlUGF0aCwgX3BhdGgpKSlcblx0XHR7XG5cdFx0XHRsZXQgbWQgPSBtYWtlTGluayhg6K2v5ZCN5bCN54WnYCwgX3BhdGgpO1xuXG5cdFx0XHRfYXJyLnB1c2goYCR7bWR9YClcblx0XHR9XG5cblx0XHRfcGF0aCA9ICfmlbTlkIjmqKPlvI8ubWQnO1xuXG5cdFx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHRcdHtcblx0XHRcdGxldCBtZCA9IG1ha2VMaW5rKGDmlbTlkIjmqKPlvI9gLCBfcGF0aCk7XG5cblx0XHRcdF9hcnIucHVzaChgJHttZH1gKVxuXHRcdH1cblxuXHRcdGlmIChfYXJyLmxlbmd0aClcblx0XHR7XG5cdFx0XHRfYXBwZW5kZWQucHVzaChgLSAgOnBlbmNpbDogJHtfYXJyLmpvaW4oJyDvvI8gJyl9YClcblx0XHR9XG5cdH1cblxuXHRfcGF0aCA9ICdqYS5tZCc7XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHR7XG5cdFx0bGV0IG1kID0gbWFrZUxpbmsoYOWQq+acieWOn+aWh+eahOeroOevgGAsIF9wYXRoKTtcblxuXHRcdF9hcHBlbmRlZC5wdXNoKGAtICR7bWR9IC0g5Y+v6IO954K65pyq57+76K2v5oiW6ICF5ZCe5qiT77yM562J5b6F5ZyW6L2J5paH5LmL6aGeYClcblx0fVxuXG5cdF9wYXRoID0gJ+W+heS/ruato+Wxj+iUveWtly5tZCc7XG5cblx0aWYgKGZzLmV4aXN0c1N5bmMocGF0aC5qb2luKGJhc2VQYXRoLCBfcGF0aCkpKVxuXHR7XG5cdFx0bGV0IG1kID0gbWFrZUxpbmsoYOW+heS/ruato+Wxj+iUveWtl2AsIF9wYXRoKTtcblxuXHRcdF9hcHBlbmRlZC5wdXNoKGAtICR7bWR9IC0g6ZyA6KaB5pyJ5Lq65Y2U5Yqp5bCHIFxcYCoqXFxgIOWFp+eahOWtl+ijnOS4imApO1xuXHR9XG5cblx0aWYgKF9hcHBlbmRlZC5sZW5ndGgpXG5cdHtcblx0XHRhcnIucHVzaChcIlxcblwiKTtcblx0XHRhcnIucHVzaCguLi5fYXBwZW5kZWQpO1xuXHR9XG5cblx0cmV0dXJuIGFycjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1ha2VMaW5rKHRpdGxlOiBzdHJpbmcsIGxpbms6IHN0cmluZywgaXNEaXI/OiBib29sZWFuKVxue1xuXHRsZXQgdCA9IG5vcm1hbGl6ZV9zdHJpcCh0aXRsZSwgaXNEaXIpO1xuXG5cdGlmICghaXNEaXIpXG5cdHtcblx0XHR0ID0gcGF0aC5iYXNlbmFtZSh0LCAnLnR4dCcpO1xuXHR9XG5cblx0dCA9IG1kX2xpbmtfZXNjYXBlKHQpO1xuXG5cdHJldHVybiBgWyR7dH1dKCR7bWRfaHJlZihsaW5rKX0pYFxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TGlzdChiYXNlUGF0aDogc3RyaW5nKVxue1xuXHRyZXR1cm4gbm92ZWxHbG9iYnkuZ2xvYmJ5QVN5bmMoW1xuXHRcdCcqKi8qLnR4dCcsXG5cdF0sIHtcblx0XHRjd2Q6IGJhc2VQYXRoLFxuXHRcdHRocm93RW1wdHk6IGZhbHNlLFxuXHR9KVxufVxuXG5leHBvcnQgZGVmYXVsdCBwcm9jZXNzVG9jQ29udGVudHNcbiJdfQ==