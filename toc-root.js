"use strict";
/**
 * Created by user on 2018/11/14/014.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const array_hyper_unique_1 = require("array-hyper-unique");
const crlf_normalize_1 = require("crlf-normalize");
const FastGlob = require("fast-glob");
const path = require("upath2");
const BluebirdPromise = require("bluebird");
const fs = require("fs-extra");
const options_1 = require("node-novel-globby/lib/options");
const util_1 = require("./lib/util");
const toc_contents_1 = require("./toc_contents");
const sortObject = require("sort-object-keys2");
const sort_1 = require("@node-novel/sort");
function searchByRoot(rootPath) {
    return BluebirdPromise.resolve(FastGlob.async([
        '!README.md',
        '!*/README.md',
        '!.*',
        '!docs',
        '*/*/**/README.md',
        '!*.new.*',
        '!*.out.*',
        '!*.raw',
        '!*.raw.*',
        '!.*',
        '!node_modules',
        '!out',
        '!raw',
    ], {
        cwd: rootPath,
        deep: 2,
    }))
        //.tap(v => console.info(v))
        .then(function (ls) {
        return filterList(ls.sort(), rootPath);
    })
        .tap(function (ls) {
        if (!ls.length) {
            console.warn(rootPath);
            return BluebirdPromise.reject(`list is empty`);
        }
    });
}
exports.searchByRoot = searchByRoot;
function isNovelID(dir, rootPath) {
    // @ts-ignore
    let _path = path.resolve(...[rootPath, path.dirname(dir)].filter(v => typeof v !== 'undefined'));
    return util_1.globFirst([
        '**/*.txt',
    ], {
        cwd: _path,
        absolute: true,
        ignore: options_1.defaultPatternsExclude,
    });
    //.tap(v => console.log(v))
}
exports.isNovelID = isNovelID;
function filterList(ls, rootPath) {
    return BluebirdPromise.reduce(ls, async function (arr, dir) {
        let dl = dir.split('/');
        if (dl.length > 3) {
            return arr;
        }
        if (!/_out$/.test(dl[0])) {
            let out = [dl[0] + '_out', ...dl.slice(1)];
            if (ls.includes(out.join('/'))) {
                return arr;
            }
        }
        let hasTxt = await isNovelID(dir, rootPath);
        if (hasTxt) {
            arr.push(dir);
        }
        return arr;
    }, [])
        .tap(function (ls) {
        if (!ls.length) {
            return BluebirdPromise.reject(`list is empty`);
        }
    });
}
exports.filterList = filterList;
function processDataByAuthor(ls, rootPath, options) {
    return BluebirdPromise.reduce(ls, async function (data, file) {
        let dl = file.split('/');
        let meta = await util_1.loadReadmeMeta(path.join(rootPath, file));
        let author = 'unknow';
        if (meta) {
            if (meta.novel) {
                if (meta.novel.author) {
                    author = meta.novel.author;
                }
                else if (meta.novel.authors && meta.novel.authors.length) {
                    author = meta.novel.authors[0];
                }
            }
        }
        else {
            return data;
        }
        data[author] = data[author] || {};
        let novelID = dl[1];
        data[author][novelID] = data[author][novelID] || [];
        data[author][novelID].push({
            novelID: dl[1],
            pathMain: dl[0],
            file,
            author,
            // @ts-ignore
            meta,
        });
        return data;
    }, {})
        .then(data => {
        sortObject(data, {
            sort: sort_1.defaultSortCallback,
            useSource: true,
        });
        Object.keys(data).forEach(function (author) {
            sortObject(data[author], {
                sort: sort_1.defaultSortCallback,
                useSource: true,
            });
        });
        let key = 'unknow';
        let old = data[key];
        delete data[key];
        if (old) {
            data[key] = old;
        }
        return data;
    });
}
exports.processDataByAuthor = processDataByAuthor;
function stringifyDataAuthor(data, rootPath, options) {
    let arr = [
        `# TOC\n`,
    ];
    let arr_author = [];
    arr_author.push(`## Author\n`);
    options = options || {};
    Object.entries(data)
        .forEach(function ([author, row], author_idx) {
        arr_author.push(`### ${author}\n`);
        Object.entries(row)
            .forEach(function ([novelID, list]) {
            arr_author.push(`#### ${novelID}\n`);
            let skip = [
                novelID,
            ];
            let titles = [];
            let arr_item = [];
            list.forEach(function (item, index) {
                let link = path.dirname(item.file);
                let link2 = path.join(link, '導航目錄.md');
                if (fs.existsSync(path.join(rootPath, link2))) {
                    link = link2;
                }
                skip.push(novelID);
                let md = toc_contents_1.makeLink(`${novelID}`, link);
                let text = `- ${md} - *${item.pathMain}*`;
                if (options.cbForEachSubNovel) {
                    let ret = options.cbForEachSubNovel(text, item);
                    if (typeof ret === 'string') {
                        text = ret;
                    }
                }
                arr_item.push(text);
                titles = titles.concat(util_1.getNovelTitles(item.meta));
            });
            titles = array_hyper_unique_1.array_unique(titles)
                .filter(v => !skip.includes(v));
            if (titles.length) {
                arr_author.push(`> ${titles.join(' , ')}\n`);
            }
            arr_author = arr_author.concat(arr_item);
            arr_author.push(crlf_normalize_1.LF);
        });
    });
    arr = arr.concat(arr_author);
    arr.push(crlf_normalize_1.LF);
    return arr.join(crlf_normalize_1.LF);
}
exports.stringifyDataAuthor = stringifyDataAuthor;
function createTocRoot(_root, outputFile, options) {
    options = options || {};
    return searchByRoot(_root)
        .then(function (ls) {
        return processDataByAuthor(ls, _root, options);
    })
        .then(function (data) {
        return stringifyDataAuthor(data, _root, options);
    })
        .tap(function (v) {
        if (outputFile) {
            return fs.outputFile(outputFile, v);
        }
    });
}
exports.createTocRoot = createTocRoot;
exports.default = createTocRoot;
//createTocRoot('D:/Users/Documents/The Project/nodejs-test/node-novel2/dist_novel').tap(v => console.dir(v))
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9jLXJvb3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0b2Mtcm9vdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsMkRBQWtEO0FBQ2xELG1EQUFvQztBQUNwQyxzQ0FBc0M7QUFDdEMsK0JBQWdDO0FBQ2hDLDRDQUE2QztBQUM3QywrQkFBK0I7QUFFL0IsMkRBQXVFO0FBRXZFLHFDQUF1RTtBQUN2RSxpREFBMEM7QUFDMUMsZ0RBQWlEO0FBQ2pELDJDQUEyRTtBQUUzRSxTQUFnQixZQUFZLENBQUMsUUFBZ0I7SUFFNUMsT0FBTyxlQUFlLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQVM7UUFDcEQsWUFBWTtRQUNaLGNBQWM7UUFDZCxLQUFLO1FBQ0wsT0FBTztRQUNQLGtCQUFrQjtRQUVsQixVQUFVO1FBQ1YsVUFBVTtRQUNWLFFBQVE7UUFDUixVQUFVO1FBQ1YsS0FBSztRQUNMLGVBQWU7UUFDZixNQUFNO1FBQ04sTUFBTTtLQUVOLEVBQUU7UUFDRixHQUFHLEVBQUUsUUFBUTtRQUNiLElBQUksRUFBRSxDQUFDO0tBQ1AsQ0FBQyxDQUFDO1FBQ0gsNEJBQTRCO1NBQzNCLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFFakIsT0FBTyxVQUFVLENBQUMsRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ3ZDLENBQUMsQ0FBQztTQUNELEdBQUcsQ0FBQyxVQUFVLEVBQUU7UUFFaEIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQ2Q7WUFDQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXZCLE9BQU8sZUFBZSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQTtTQUM5QztJQUNGLENBQUMsQ0FBQyxDQUNEO0FBQ0gsQ0FBQztBQXJDRCxvQ0FxQ0M7QUFFRCxTQUFnQixTQUFTLENBQUMsR0FBVyxFQUFFLFFBQWlCO0lBRXZELGFBQWE7SUFDYixJQUFJLEtBQUssR0FBVyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFFekcsT0FBTyxnQkFBUyxDQUFDO1FBQ2hCLFVBQVU7S0FFVixFQUFFO1FBQ0YsR0FBRyxFQUFFLEtBQUs7UUFDVixRQUFRLEVBQUUsSUFBSTtRQUNkLE1BQU0sRUFBRSxnQ0FBc0I7S0FDOUIsQ0FBQyxDQUFBO0lBQ0YsMkJBQTJCO0FBQzVCLENBQUM7QUFkRCw4QkFjQztBQUVELFNBQWdCLFVBQVUsQ0FBQyxFQUFZLEVBQUUsUUFBaUI7SUFFekQsT0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxLQUFLLFdBQVcsR0FBRyxFQUFFLEdBQUc7UUFFeEQsSUFBSSxFQUFFLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV4QixJQUFJLEVBQUUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUNqQjtZQUNDLE9BQU8sR0FBRyxDQUFDO1NBQ1g7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFDeEI7WUFDQyxJQUFJLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFM0MsSUFBSSxFQUFFLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFDOUI7Z0JBQ0MsT0FBTyxHQUFHLENBQUM7YUFDWDtTQUNEO1FBRUQsSUFBSSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRTVDLElBQUksTUFBTSxFQUNWO1lBQ0MsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNkO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDLEVBQUUsRUFBYyxDQUFDO1NBQ2pCLEdBQUcsQ0FBQyxVQUFVLEVBQUU7UUFFaEIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQ2Q7WUFDQyxPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUE7U0FDOUM7SUFDRixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFyQ0QsZ0NBcUNDO0FBRUQsU0FBZ0IsbUJBQW1CLENBQXNDLEVBQVksRUFBRSxRQUFnQixFQUFFLE9BQXFCO0lBRTdILE9BQU8sZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsS0FBSyxXQUFXLElBQUksRUFBRSxJQUFJO1FBRTFELElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFekIsSUFBSSxJQUFJLEdBQUcsTUFBTSxxQkFBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFM0QsSUFBSSxNQUFNLEdBQUcsUUFBUSxDQUFDO1FBRXRCLElBQUksSUFBSSxFQUNSO1lBQ0MsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUNkO2dCQUNDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQ3JCO29CQUNDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQTtpQkFDMUI7cUJBQ0ksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQ3hEO29CQUNDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDOUI7YUFDRDtTQUNEO2FBRUQ7WUFDQyxPQUFPLElBQUksQ0FBQztTQUNaO1FBRUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7UUFFbEMsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXBCLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXBELElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFDMUIsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDZCxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNmLElBQUk7WUFDSixNQUFNO1lBQ04sYUFBYTtZQUNiLElBQUk7U0FDSixDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUMsRUFBRSxFQUFvQixDQUFDO1NBQ3ZCLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUdaLFVBQVUsQ0FBQyxJQUFJLEVBQUU7WUFDaEIsSUFBSSxFQUFFLDBCQUFtQjtZQUN6QixTQUFTLEVBQUUsSUFBSTtTQUNmLENBQUMsQ0FBQztRQUVILE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVUsTUFBTTtZQUV6QyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUN4QixJQUFJLEVBQUUsMEJBQW1CO2dCQUN6QixTQUFTLEVBQUUsSUFBSTthQUNmLENBQUMsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDO1FBQ25CLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVwQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVqQixJQUFJLEdBQUcsRUFDUDtZQUNDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7U0FDaEI7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNiLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQTFFRCxrREEwRUM7QUE0QkQsU0FBZ0IsbUJBQW1CLENBQXNDLElBQW9CLEVBQUUsUUFBZ0IsRUFBRSxPQUFxQjtJQUVySSxJQUFJLEdBQUcsR0FBRztRQUNULFNBQVM7S0FDVCxDQUFDO0lBRUYsSUFBSSxVQUFVLEdBQWEsRUFBRSxDQUFDO0lBRTlCLFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFL0IsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFeEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7U0FDbEIsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEVBQUUsVUFBVTtRQUUzQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sTUFBTSxJQUFJLENBQUMsQ0FBQTtRQUVsQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQzthQUNqQixPQUFPLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7WUFHakMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLE9BQU8sSUFBSSxDQUFDLENBQUM7WUFFckMsSUFBSSxJQUFJLEdBQUc7Z0JBQ1YsT0FBTzthQUNQLENBQUM7WUFFRixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFFaEIsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO1lBRWxCLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLEVBQUUsS0FBSztnQkFFakMsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBRW5DLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUV2QyxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUMsRUFDN0M7b0JBQ0MsSUFBSSxHQUFHLEtBQUssQ0FBQTtpQkFDWjtnQkFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUVuQixJQUFJLEVBQUUsR0FBRyx1QkFBUSxDQUFDLEdBQUcsT0FBTyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBRXRDLElBQUksSUFBSSxHQUFHLEtBQUssRUFBRSxPQUFPLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQztnQkFFMUMsSUFBSSxPQUFPLENBQUMsaUJBQWlCLEVBQzdCO29CQUNDLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBRWhELElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxFQUMzQjt3QkFDQyxJQUFJLEdBQUcsR0FBRyxDQUFDO3FCQUNYO2lCQUNEO2dCQUVELFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBRXBCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLHFCQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7WUFDbEQsQ0FBQyxDQUFDLENBQUM7WUFFSCxNQUFNLEdBQUcsaUNBQVksQ0FBQyxNQUFNLENBQUM7aUJBQzNCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUMvQjtZQUVELElBQUksTUFBTSxDQUFDLE1BQU0sRUFDakI7Z0JBQ0MsVUFBVSxDQUFDLElBQUksQ0FBQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzdDO1lBRUQsVUFBVSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFekMsVUFBVSxDQUFDLElBQUksQ0FBQyxtQkFBRSxDQUFDLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQ0Y7SUFDRixDQUFDLENBQUMsQ0FDRjtJQUVELEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRTdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsbUJBQUUsQ0FBQyxDQUFDO0lBRWIsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLG1CQUFFLENBQUMsQ0FBQTtBQUNwQixDQUFDO0FBckZELGtEQXFGQztBQUVELFNBQWdCLGFBQWEsQ0FBc0MsS0FBYSxFQUFFLFVBQW1CLEVBQUUsT0FBcUI7SUFFM0gsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFFeEIsT0FBTyxZQUFZLENBQUMsS0FBSyxDQUFDO1NBQ3hCLElBQUksQ0FBQyxVQUFVLEVBQUU7UUFFakIsT0FBTyxtQkFBbUIsQ0FBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ25ELENBQUMsQ0FBQztTQUNELElBQUksQ0FBQyxVQUFVLElBQUk7UUFFbkIsT0FBTyxtQkFBbUIsQ0FBSSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBQ3BELENBQUMsQ0FBQztTQUNELEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFFZixJQUFJLFVBQVUsRUFDZDtZQUNDLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDcEM7SUFDRixDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUFyQkQsc0NBcUJDO0FBRUQsa0JBQWUsYUFBYSxDQUFBO0FBRTVCLDZHQUE2RyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvMTEvMTQvMDE0LlxuICovXG5cbmltcG9ydCB7IGFycmF5X3VuaXF1ZSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5pbXBvcnQgeyBMRiB9IGZyb20gJ2NybGYtbm9ybWFsaXplJztcbmltcG9ydCAqIGFzIEZhc3RHbG9iIGZyb20gJ2Zhc3QtZ2xvYic7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuaW1wb3J0IEJsdWViaXJkUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBub3ZlbEdsb2JieSBmcm9tICdub2RlLW5vdmVsLWdsb2JieS9nJztcbmltcG9ydCB7IGRlZmF1bHRQYXR0ZXJuc0V4Y2x1ZGUgfSBmcm9tICdub2RlLW5vdmVsLWdsb2JieS9saWIvb3B0aW9ucyc7XG5pbXBvcnQgeyBJTWRjb25mTWV0YSB9IGZyb20gJ25vZGUtbm92ZWwtaW5mbyc7XG5pbXBvcnQgeyBnbG9iRmlyc3QsIGxvYWRSZWFkbWVNZXRhLCBnZXROb3ZlbFRpdGxlcyB9IGZyb20gJy4vbGliL3V0aWwnO1xuaW1wb3J0IHsgbWFrZUxpbmsgfSBmcm9tICcuL3RvY19jb250ZW50cyc7XG5pbXBvcnQgc29ydE9iamVjdCA9IHJlcXVpcmUoJ3NvcnQtb2JqZWN0LWtleXMyJyk7XG5pbXBvcnQgeyBkZWZhdWx0U29ydENhbGxiYWNrLCBjcmVhdGVTb3J0Q2FsbGJhY2sgfSBmcm9tICdAbm9kZS1ub3ZlbC9zb3J0JztcblxuZXhwb3J0IGZ1bmN0aW9uIHNlYXJjaEJ5Um9vdChyb290UGF0aDogc3RyaW5nKVxue1xuXHRyZXR1cm4gQmx1ZWJpcmRQcm9taXNlLnJlc29sdmUoRmFzdEdsb2IuYXN5bmM8c3RyaW5nPihbXG5cdFx0XHQnIVJFQURNRS5tZCcsXG5cdFx0XHQnISovUkVBRE1FLm1kJyxcblx0XHRcdCchLionLFxuXHRcdFx0JyFkb2NzJyxcblx0XHRcdCcqLyovKiovUkVBRE1FLm1kJyxcblxuXHRcdFx0JyEqLm5ldy4qJyxcblx0XHRcdCchKi5vdXQuKicsXG5cdFx0XHQnISoucmF3Jyxcblx0XHRcdCchKi5yYXcuKicsXG5cdFx0XHQnIS4qJyxcblx0XHRcdCchbm9kZV9tb2R1bGVzJyxcblx0XHRcdCchb3V0Jyxcblx0XHRcdCchcmF3JyxcblxuXHRcdF0sIHtcblx0XHRcdGN3ZDogcm9vdFBhdGgsXG5cdFx0XHRkZWVwOiAyLFxuXHRcdH0pKVxuXHRcdC8vLnRhcCh2ID0+IGNvbnNvbGUuaW5mbyh2KSlcblx0XHQudGhlbihmdW5jdGlvbiAobHMpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIGZpbHRlckxpc3QobHMuc29ydCgpLCByb290UGF0aClcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdGlmICghbHMubGVuZ3RoKVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zb2xlLndhcm4ocm9vdFBhdGgpO1xuXG5cdFx0XHRcdHJldHVybiBCbHVlYmlyZFByb21pc2UucmVqZWN0KGBsaXN0IGlzIGVtcHR5YClcblx0XHRcdH1cblx0XHR9KVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzTm92ZWxJRChkaXI6IHN0cmluZywgcm9vdFBhdGg/OiBzdHJpbmcpXG57XG5cdC8vIEB0cy1pZ25vcmVcblx0bGV0IF9wYXRoOiBzdHJpbmcgPSBwYXRoLnJlc29sdmUoLi4uW3Jvb3RQYXRoLCBwYXRoLmRpcm5hbWUoZGlyKV0uZmlsdGVyKHYgPT4gdHlwZW9mIHYgIT09ICd1bmRlZmluZWQnKSk7XG5cblx0cmV0dXJuIGdsb2JGaXJzdChbXG5cdFx0JyoqLyoudHh0Jyxcblx0XHQvLy4uLmRlZmF1bHRQYXR0ZXJuc0V4Y2x1ZGUsXG5cdF0sIHtcblx0XHRjd2Q6IF9wYXRoLFxuXHRcdGFic29sdXRlOiB0cnVlLFxuXHRcdGlnbm9yZTogZGVmYXVsdFBhdHRlcm5zRXhjbHVkZSxcblx0fSlcblx0Ly8udGFwKHYgPT4gY29uc29sZS5sb2codikpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJMaXN0KGxzOiBzdHJpbmdbXSwgcm9vdFBhdGg/OiBzdHJpbmcpXG57XG5cdHJldHVybiBCbHVlYmlyZFByb21pc2UucmVkdWNlKGxzLCBhc3luYyBmdW5jdGlvbiAoYXJyLCBkaXIpXG5cdFx0e1xuXHRcdFx0bGV0IGRsID0gZGlyLnNwbGl0KCcvJyk7XG5cblx0XHRcdGlmIChkbC5sZW5ndGggPiAzKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gYXJyO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIS9fb3V0JC8udGVzdChkbFswXSkpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBvdXQgPSBbZGxbMF0gKyAnX291dCcsIC4uLmRsLnNsaWNlKDEpXTtcblxuXHRcdFx0XHRpZiAobHMuaW5jbHVkZXMob3V0LmpvaW4oJy8nKSkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXR1cm4gYXJyO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdGxldCBoYXNUeHQgPSBhd2FpdCBpc05vdmVsSUQoZGlyLCByb290UGF0aCk7XG5cblx0XHRcdGlmIChoYXNUeHQpXG5cdFx0XHR7XG5cdFx0XHRcdGFyci5wdXNoKGRpcik7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBhcnI7XG5cdFx0fSwgW10gYXMgc3RyaW5nW10pXG5cdFx0LnRhcChmdW5jdGlvbiAobHMpXG5cdFx0e1xuXHRcdFx0aWYgKCFscy5sZW5ndGgpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBCbHVlYmlyZFByb21pc2UucmVqZWN0KGBsaXN0IGlzIGVtcHR5YClcblx0XHRcdH1cblx0XHR9KVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc0RhdGFCeUF1dGhvcjxUIGV4dGVuZHMgSU1kY29uZk1ldGEgPSBJTWRjb25mTWV0YT4obHM6IHN0cmluZ1tdLCByb290UGF0aDogc3RyaW5nLCBvcHRpb25zPzogSU9wdGlvbnM8VD4pXG57XG5cdHJldHVybiBCbHVlYmlyZFByb21pc2UucmVkdWNlKGxzLCBhc3luYyBmdW5jdGlvbiAoZGF0YSwgZmlsZSlcblx0XHR7XG5cdFx0XHRsZXQgZGwgPSBmaWxlLnNwbGl0KCcvJyk7XG5cblx0XHRcdGxldCBtZXRhID0gYXdhaXQgbG9hZFJlYWRtZU1ldGEocGF0aC5qb2luKHJvb3RQYXRoLCBmaWxlKSk7XG5cblx0XHRcdGxldCBhdXRob3IgPSAndW5rbm93JztcblxuXHRcdFx0aWYgKG1ldGEpXG5cdFx0XHR7XG5cdFx0XHRcdGlmIChtZXRhLm5vdmVsKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKG1ldGEubm92ZWwuYXV0aG9yKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGF1dGhvciA9IG1ldGEubm92ZWwuYXV0aG9yXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdGVsc2UgaWYgKG1ldGEubm92ZWwuYXV0aG9ycyAmJiBtZXRhLm5vdmVsLmF1dGhvcnMubGVuZ3RoKVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGF1dGhvciA9IG1ldGEubm92ZWwuYXV0aG9yc1swXVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gZGF0YTtcblx0XHRcdH1cblxuXHRcdFx0ZGF0YVthdXRob3JdID0gZGF0YVthdXRob3JdIHx8IHt9O1xuXG5cdFx0XHRsZXQgbm92ZWxJRCA9IGRsWzFdO1xuXG5cdFx0XHRkYXRhW2F1dGhvcl1bbm92ZWxJRF0gPSBkYXRhW2F1dGhvcl1bbm92ZWxJRF0gfHwgW107XG5cblx0XHRcdGRhdGFbYXV0aG9yXVtub3ZlbElEXS5wdXNoKHtcblx0XHRcdFx0bm92ZWxJRDogZGxbMV0sXG5cdFx0XHRcdHBhdGhNYWluOiBkbFswXSxcblx0XHRcdFx0ZmlsZSxcblx0XHRcdFx0YXV0aG9yLFxuXHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdG1ldGEsXG5cdFx0XHR9KTtcblxuXHRcdFx0cmV0dXJuIGRhdGE7XG5cdFx0fSwge30gYXMgSURhdGFBdXRob3I8VD4pXG5cdFx0LnRoZW4oZGF0YSA9PlxuXHRcdHtcblxuXHRcdFx0c29ydE9iamVjdChkYXRhLCB7XG5cdFx0XHRcdHNvcnQ6IGRlZmF1bHRTb3J0Q2FsbGJhY2ssXG5cdFx0XHRcdHVzZVNvdXJjZTogdHJ1ZSxcblx0XHRcdH0pO1xuXG5cdFx0XHRPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChhdXRob3IpXG5cdFx0XHR7XG5cdFx0XHRcdHNvcnRPYmplY3QoZGF0YVthdXRob3JdLCB7XG5cdFx0XHRcdFx0c29ydDogZGVmYXVsdFNvcnRDYWxsYmFjayxcblx0XHRcdFx0XHR1c2VTb3VyY2U6IHRydWUsXG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cblx0XHRcdGxldCBrZXkgPSAndW5rbm93Jztcblx0XHRcdGxldCBvbGQgPSBkYXRhW2tleV07XG5cblx0XHRcdGRlbGV0ZSBkYXRhW2tleV07XG5cblx0XHRcdGlmIChvbGQpXG5cdFx0XHR7XG5cdFx0XHRcdGRhdGFba2V5XSA9IG9sZDtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGRhdGE7XG5cdFx0fSlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRGF0YUF1dGhvcjxUIGV4dGVuZHMgSU1kY29uZk1ldGEgPSBJTWRjb25mTWV0YT5cbntcblx0W2F1dGhvcjogc3RyaW5nXTogSURhdGFBdXRob3JOb3ZlbDxUPixcblx0dW5rbm93PzogSURhdGFBdXRob3JOb3ZlbDxUPixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRGF0YUF1dGhvck5vdmVsPFQgZXh0ZW5kcyBJTWRjb25mTWV0YSA9IElNZGNvbmZNZXRhPlxue1xuXHRbbm92ZWxJRDogc3RyaW5nXTogSURhdGFBdXRob3JOb3ZlbEl0ZW08VD5bXVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElEYXRhQXV0aG9yTm92ZWxJdGVtPFQgZXh0ZW5kcyBJTWRjb25mTWV0YSA9IElNZGNvbmZNZXRhPlxue1xuXHRub3ZlbElEOiBzdHJpbmcsXG5cdHBhdGhNYWluOiBzdHJpbmcsXG5cdGZpbGU6IHN0cmluZyxcblx0YXV0aG9yOiBzdHJpbmcgfCAndW5rbm93Jyxcblx0bWV0YTogVCxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJT3B0aW9uczxUIGV4dGVuZHMgSU1kY29uZk1ldGE+XG57XG5cdGNiRm9yRWFjaFN1Yk5vdmVsPyh0ZXh0OiBzdHJpbmcsIGl0ZW06IElEYXRhQXV0aG9yTm92ZWxJdGVtPFQ+KTogc3RyaW5nLFxuXHRjYkZvckVhY2hTdWJOb3ZlbD8odGV4dDogc3RyaW5nLCBpdGVtOiBJRGF0YUF1dGhvck5vdmVsSXRlbTxUPik6IHZvaWQsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdHJpbmdpZnlEYXRhQXV0aG9yPFQgZXh0ZW5kcyBJTWRjb25mTWV0YSA9IElNZGNvbmZNZXRhPihkYXRhOiBJRGF0YUF1dGhvcjxUPiwgcm9vdFBhdGg6IHN0cmluZywgb3B0aW9ucz86IElPcHRpb25zPFQ+KVxue1xuXHRsZXQgYXJyID0gW1xuXHRcdGAjIFRPQ1xcbmAsXG5cdF07XG5cblx0bGV0IGFycl9hdXRob3I6IHN0cmluZ1tdID0gW107XG5cblx0YXJyX2F1dGhvci5wdXNoKGAjIyBBdXRob3JcXG5gKTtcblxuXHRvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcblxuXHRPYmplY3QuZW50cmllcyhkYXRhKVxuXHRcdC5mb3JFYWNoKGZ1bmN0aW9uIChbYXV0aG9yLCByb3ddLCBhdXRob3JfaWR4KVxuXHRcdHtcblx0XHRcdGFycl9hdXRob3IucHVzaChgIyMjICR7YXV0aG9yfVxcbmApXG5cblx0XHRcdE9iamVjdC5lbnRyaWVzKHJvdylcblx0XHRcdFx0LmZvckVhY2goZnVuY3Rpb24gKFtub3ZlbElELCBsaXN0XSlcblx0XHRcdFx0e1xuXG5cdFx0XHRcdFx0YXJyX2F1dGhvci5wdXNoKGAjIyMjICR7bm92ZWxJRH1cXG5gKTtcblxuXHRcdFx0XHRcdGxldCBza2lwID0gW1xuXHRcdFx0XHRcdFx0bm92ZWxJRCxcblx0XHRcdFx0XHRdO1xuXG5cdFx0XHRcdFx0bGV0IHRpdGxlcyA9IFtdO1xuXG5cdFx0XHRcdFx0bGV0IGFycl9pdGVtID0gW107XG5cblx0XHRcdFx0XHRsaXN0LmZvckVhY2goZnVuY3Rpb24gKGl0ZW0sIGluZGV4KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGxldCBsaW5rID0gcGF0aC5kaXJuYW1lKGl0ZW0uZmlsZSk7XG5cblx0XHRcdFx0XHRcdGxldCBsaW5rMiA9IHBhdGguam9pbihsaW5rLCAn5bCO6Iiq55uu6YyELm1kJyk7XG5cblx0XHRcdFx0XHRcdGlmIChmcy5leGlzdHNTeW5jKHBhdGguam9pbihyb290UGF0aCwgbGluazIpKSlcblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0bGluayA9IGxpbmsyXG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdHNraXAucHVzaChub3ZlbElEKTtcblxuXHRcdFx0XHRcdFx0bGV0IG1kID0gbWFrZUxpbmsoYCR7bm92ZWxJRH1gLCBsaW5rKTtcblxuXHRcdFx0XHRcdFx0bGV0IHRleHQgPSBgLSAke21kfSAtICoke2l0ZW0ucGF0aE1haW59KmA7XG5cblx0XHRcdFx0XHRcdGlmIChvcHRpb25zLmNiRm9yRWFjaFN1Yk5vdmVsKVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRsZXQgcmV0ID0gb3B0aW9ucy5jYkZvckVhY2hTdWJOb3ZlbCh0ZXh0LCBpdGVtKTtcblxuXHRcdFx0XHRcdFx0XHRpZiAodHlwZW9mIHJldCA9PT0gJ3N0cmluZycpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHR0ZXh0ID0gcmV0O1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdGFycl9pdGVtLnB1c2godGV4dCk7XG5cblx0XHRcdFx0XHRcdHRpdGxlcyA9IHRpdGxlcy5jb25jYXQoZ2V0Tm92ZWxUaXRsZXMoaXRlbS5tZXRhKSlcblx0XHRcdFx0XHR9KTtcblxuXHRcdFx0XHRcdHRpdGxlcyA9IGFycmF5X3VuaXF1ZSh0aXRsZXMpXG5cdFx0XHRcdFx0XHQuZmlsdGVyKHYgPT4gIXNraXAuaW5jbHVkZXModikpXG5cdFx0XHRcdFx0O1xuXG5cdFx0XHRcdFx0aWYgKHRpdGxlcy5sZW5ndGgpXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0YXJyX2F1dGhvci5wdXNoKGA+ICR7dGl0bGVzLmpvaW4oJyAsICcpfVxcbmApO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGFycl9hdXRob3IgPSBhcnJfYXV0aG9yLmNvbmNhdChhcnJfaXRlbSk7XG5cblx0XHRcdFx0XHRhcnJfYXV0aG9yLnB1c2goTEYpO1xuXHRcdFx0XHR9KVxuXHRcdFx0O1xuXHRcdH0pXG5cdDtcblxuXHRhcnIgPSBhcnIuY29uY2F0KGFycl9hdXRob3IpO1xuXG5cdGFyci5wdXNoKExGKTtcblxuXHRyZXR1cm4gYXJyLmpvaW4oTEYpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVUb2NSb290PFQgZXh0ZW5kcyBJTWRjb25mTWV0YSA9IElNZGNvbmZNZXRhPihfcm9vdDogc3RyaW5nLCBvdXRwdXRGaWxlPzogc3RyaW5nLCBvcHRpb25zPzogSU9wdGlvbnM8VD4pXG57XG5cdG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuXG5cdHJldHVybiBzZWFyY2hCeVJvb3QoX3Jvb3QpXG5cdFx0LnRoZW4oZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdHJldHVybiBwcm9jZXNzRGF0YUJ5QXV0aG9yPFQ+KGxzLCBfcm9vdCwgb3B0aW9ucyk7XG5cdFx0fSlcblx0XHQudGhlbihmdW5jdGlvbiAoZGF0YSlcblx0XHR7XG5cdFx0XHRyZXR1cm4gc3RyaW5naWZ5RGF0YUF1dGhvcjxUPihkYXRhLCBfcm9vdCwgb3B0aW9ucylcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKHYpXG5cdFx0e1xuXHRcdFx0aWYgKG91dHB1dEZpbGUpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBmcy5vdXRwdXRGaWxlKG91dHB1dEZpbGUsIHYpO1xuXHRcdFx0fVxuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjcmVhdGVUb2NSb290XG5cbi8vY3JlYXRlVG9jUm9vdCgnRDovVXNlcnMvRG9jdW1lbnRzL1RoZSBQcm9qZWN0L25vZGVqcy10ZXN0L25vZGUtbm92ZWwyL2Rpc3Rfbm92ZWwnKS50YXAodiA9PiBjb25zb2xlLmRpcih2KSlcbiJdfQ==