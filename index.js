"use strict";
/**
 * Created by user on 2018/5/1/001.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const array_hyper_unique_1 = require("array-hyper-unique");
const Promise = require("bluebird");
exports.Promise = Promise;
const debug_color2_1 = require("debug-color2");
const FastGlob = require("fast-glob");
const fs = require("fs-extra");
const node_novel_info_1 = require("node-novel-info");
const sortObjectKeys = require("sort-object-keys2");
const self = require("./index");
const util_1 = require("./lib/util");
exports.md_href = util_1.md_href;
const path = require("upath2");
exports.console = new debug_color2_1.Console(null, {
    enabled: true,
    inspectOptions: {
        colors: true,
    },
    chalkOptions: {
        enabled: true,
    },
});
exports.console.enabledColor = true;
function get_ids(cwd, filter) {
    return Promise.resolve(FastGlob([
        '*',
        '!docs',
        '!.*',
        '!*.raw',
        '!raw',
    ], {
        deep: 1,
        onlyDirectories: true,
        markDirectories: false,
        cwd,
    }))
        .then(function (ls) {
        if (filter) {
            return ls.filter(filter);
        }
        return ls;
    });
}
exports.get_ids = get_ids;
function processToc(DIST_NOVEL_ROOT, filter) {
    return get_ids(DIST_NOVEL_ROOT, filter)
        .then(async function (ls) {
        if (!ls.length) {
            return Promise.reject(`get_ids return empty`);
        }
        return ls;
    })
        .tap(function () {
        exports.console.debug(`[TOC] 開始建立 toc 列表`);
    })
        .reduce(async function (toc_ls, pathMain) {
        const cwd = path.join(DIST_NOVEL_ROOT, pathMain);
        const IS_OUT = /_out$/.test(pathMain);
        //console.log(`[TOC] 檢查 ${pathMain}`);
        let bool = false;
        await Promise
            .reduce(FastGlob([
            '*/README.md',
        ], {
            cwd,
        }), function (ret, item) {
            return createReadmeData(cwd, ret, item);
        }, {})
            .tap(async function (ret) {
            if (!Object.keys(ret).length) {
                exports.console.gray(`[TOC] 忽略 ${pathMain}`);
                return null;
            }
            bool = true;
            exports.console.debug(`[TOC] 處理 ${pathMain}`);
            toc_ls[pathMain] = ret;
            ret = Object.keys(ret)
                .sort()
                .reduce(function (a, item_id) {
                let item = ret[item_id];
                item.link = `[${item_id}](${util_1.md_href(item_id)}/)`;
                let target_id = IS_OUT ? pathMain.replace(/_out$/, '') : pathMain + '_out';
                let link_path = path.join(DIST_NOVEL_ROOT, target_id, item_id);
                //console.log(link_path, fs.existsSync(link_path));
                if (fs.existsSync(link_path)) {
                    item[IS_OUT
                        ? 'link_source'
                        : 'link_output'] = `[${item_id}](../${target_id}/${util_1.md_href(item_id)}/)`;
                }
                if (Array.isArray(item.titles)) {
                    item.titles = array_hyper_unique_1.array_unique(item.titles)
                        .filter(v => v);
                }
                if (Array.isArray(item.tags)) {
                    item.tags = array_hyper_unique_1.array_unique(item.tags)
                        .filter(v => v);
                }
                if (!item.titles) {
                    delete item.titles;
                }
                else if (item.titles.length == 1) {
                    // @ts-ignore
                    item.titles = item.titles[0];
                }
                if (item.tags) {
                    // @ts-ignore
                    item.tags = item.tags.join(' , ');
                }
                sortObjectKeys(item, {
                    useSource: true,
                    keys: [
                        'link',
                        'link_output',
                        'link_source',
                        'titles',
                        'tags',
                    ],
                });
                a[item_id] = item;
                return a;
            }, {});
            let md = node_novel_info_1.mdconf.stringify({
                toc: ret,
            });
            //console.log(pathMain, ret);
            //console.log(md);
            await fs.writeFile(path.join(cwd, 'README.md'), md);
        });
        return toc_ls;
    }, {})
        .tap(function () {
        exports.console.debug(`[TOC] 結束建立 toc 列表`);
    });
}
exports.processToc = processToc;
// @ts-ignore
async function createReadmeData(cwd, ret, item) {
    let item_id = path.basename(path.dirname(item));
    let meta_file = path.join(cwd, item);
    let meta = await fs.readFile(meta_file)
        .then(node_novel_info_1.mdconf_parse)
        .catch(function (err) {
        exports.console.error(err.toString());
        return null;
    });
    ret[item_id] = {
        titles: [],
        tags: [],
    };
    {
        let titles = [];
        titles.push(item_id);
        if (meta) {
            titles.push(meta.novel.title);
            titles.push(meta.novel.title_zh);
            titles.push(meta.novel.title_jp);
            titles.push(meta.novel.title_en);
            titles.push(meta.novel.title_short);
            // @ts-ignore
            titles.push(meta.novel.title_tw);
            // @ts-ignore
            titles.push(meta.novel.title_cn);
            // @ts-ignore
            titles.push(meta.novel.title_source);
            // @ts-ignore
            titles.push(meta.novel.title_other);
            // @ts-ignore
            titles.push(meta.novel.title_output);
            if (meta.novel.series) {
                titles.push(meta.novel.series.name);
                titles.push(meta.novel.series.name_short);
            }
            if (meta.novel.author) {
                ret[item_id].tags.push(meta.novel.author);
            }
        }
        titles = array_hyper_unique_1.array_unique(titles.filter(v => v));
        if (titles.length == 1 && titles[0] == item_id) {
            titles = null;
        }
        ret[item_id].titles = titles;
    }
    if (meta && meta.novel.tags) {
        ret[item_id].tags = ret[item_id].tags
            .concat(Object.values(meta.novel.tags));
    }
    return ret;
}
exports.createReadmeData = createReadmeData;
function defaultFilter(value) {
    return true;
}
exports.defaultFilter = defaultFilter;
exports.default = self;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7O0dBRUc7O0FBRUgsMkRBQWtEO0FBQ2xELG9DQUFvQztBQXVCM0IsMEJBQU87QUF0QmhCLCtDQUF1QztBQUN2QyxzQ0FBc0M7QUFDdEMsK0JBQStCO0FBQy9CLHFEQUFvRTtBQUNwRSxvREFBb0Q7QUFDcEQsZ0NBQWdDO0FBQ2hDLHFDQUFxQztBQUU1QixrQkFGQSxjQUFPLENBRUE7QUFEaEIsK0JBQWdDO0FBR25CLFFBQUEsT0FBTyxHQUFHLElBQUksc0JBQU8sQ0FBQyxJQUFJLEVBQUU7SUFDeEMsT0FBTyxFQUFFLElBQUk7SUFDYixjQUFjLEVBQUU7UUFDZixNQUFNLEVBQUUsSUFBSTtLQUNaO0lBQ0QsWUFBWSxFQUFFO1FBQ2IsT0FBTyxFQUFFLElBQUk7S0FDYjtDQUNELENBQUMsQ0FBQztBQUVILGVBQU8sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBSTVCLFNBQWdCLE9BQU8sQ0FBQyxHQUFXLEVBQUUsTUFBNkI7SUFFakUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBUztRQUN0QyxHQUFHO1FBQ0gsT0FBTztRQUNQLEtBQUs7UUFDTCxRQUFRO1FBQ1IsTUFBTTtLQUNOLEVBQUU7UUFDRixJQUFJLEVBQUUsQ0FBQztRQUNQLGVBQWUsRUFBRSxJQUFJO1FBQ3JCLGVBQWUsRUFBRSxLQUFLO1FBQ3RCLEdBQUc7S0FDSCxDQUFDLENBQUM7U0FDRixJQUFJLENBQUMsVUFBVSxFQUFFO1FBRWpCLElBQUksTUFBTSxFQUNWO1lBQ0MsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3pCO1FBRUQsT0FBTyxFQUFFLENBQUM7SUFDWCxDQUFDLENBQUMsQ0FDRDtBQUNILENBQUM7QUF4QkQsMEJBd0JDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLGVBQXVCLEVBQUUsTUFBNkI7SUFFaEYs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TUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sRUFDOUM7WUFDQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1NBQ2Q7UUFFRCxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztLQUM3QjtJQUVELElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUMzQjtRQUNDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUk7YUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUN2QztLQUNEO0lBRUQsT0FBTyxHQUFHLENBQUM7QUFDWixDQUFDO0FBMUVELDRDQTBFQztBQUVELFNBQWdCLGFBQWEsQ0FBQyxLQUFhO0lBRTFDLE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBQztBQUhELHNDQUdDO0FBRUQsa0JBQWUsSUFBSSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC81LzEvMDAxLlxuICovXG5cbmltcG9ydCB7IGFycmF5X3VuaXF1ZSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5pbXBvcnQgKiBhcyBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IENvbnNvbGUgfSBmcm9tICdkZWJ1Zy1jb2xvcjInO1xuaW1wb3J0ICogYXMgRmFzdEdsb2IgZnJvbSAnZmFzdC1nbG9iJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCB7IElNZGNvbmZNZXRhLCBtZGNvbmYsIG1kY29uZl9wYXJzZSB9IGZyb20gJ25vZGUtbm92ZWwtaW5mbyc7XG5pbXBvcnQgKiBhcyBzb3J0T2JqZWN0S2V5cyBmcm9tICdzb3J0LW9iamVjdC1rZXlzMic7XG5pbXBvcnQgKiBhcyBzZWxmIGZyb20gJy4vaW5kZXgnO1xuaW1wb3J0IHsgbWRfaHJlZiB9IGZyb20gJy4vbGliL3V0aWwnO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCd1cGF0aDInKTtcbmV4cG9ydCB7IG1kX2hyZWYgfVxuXG5leHBvcnQgY29uc3QgY29uc29sZSA9IG5ldyBDb25zb2xlKG51bGwsIHtcblx0ZW5hYmxlZDogdHJ1ZSxcblx0aW5zcGVjdE9wdGlvbnM6IHtcblx0XHRjb2xvcnM6IHRydWUsXG5cdH0sXG5cdGNoYWxrT3B0aW9uczoge1xuXHRcdGVuYWJsZWQ6IHRydWUsXG5cdH0sXG59KTtcblxuY29uc29sZS5lbmFibGVkQ29sb3IgPSB0cnVlO1xuXG5leHBvcnQgeyBQcm9taXNlIH1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldF9pZHMoY3dkOiBzdHJpbmcsIGZpbHRlcj86IHR5cGVvZiBkZWZhdWx0RmlsdGVyKVxue1xuXHRyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKEZhc3RHbG9iPHN0cmluZz4oW1xuXHRcdFx0JyonLFxuXHRcdFx0JyFkb2NzJyxcblx0XHRcdCchLionLFxuXHRcdFx0JyEqLnJhdycsXG5cdFx0XHQnIXJhdycsXG5cdFx0XSwge1xuXHRcdFx0ZGVlcDogMSxcblx0XHRcdG9ubHlEaXJlY3RvcmllczogdHJ1ZSxcblx0XHRcdG1hcmtEaXJlY3RvcmllczogZmFsc2UsXG5cdFx0XHRjd2QsXG5cdFx0fSkpXG5cdFx0LnRoZW4oZnVuY3Rpb24gKGxzKVxuXHRcdHtcblx0XHRcdGlmIChmaWx0ZXIpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBscy5maWx0ZXIoZmlsdGVyKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGxzO1xuXHRcdH0pXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJvY2Vzc1RvYyhESVNUX05PVkVMX1JPT1Q6IHN0cmluZywgZmlsdGVyPzogdHlwZW9mIGRlZmF1bHRGaWx0ZXIpXG57XG5cdHJldHVybiBnZXRfaWRzKERJU1RfTk9WRUxfUk9PVCwgZmlsdGVyKVxuXHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uIChscylcblx0XHR7XG5cdFx0XHRpZiAoIWxzLmxlbmd0aClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIFByb21pc2UucmVqZWN0KGBnZXRfaWRzIHJldHVybiBlbXB0eWApXG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBscztcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHR7XG5cdFx0XHRjb25zb2xlLmRlYnVnKGBbVE9DXSDplovlp4vlu7rnq4sgdG9jIOWIl+ihqGApO1xuXHRcdH0pXG5cdFx0LnJlZHVjZShhc3luYyBmdW5jdGlvbiAodG9jX2xzLCBwYXRoTWFpbjogc3RyaW5nKVxuXHRcdHtcblx0XHRcdGNvbnN0IGN3ZCA9IHBhdGguam9pbihESVNUX05PVkVMX1JPT1QsIHBhdGhNYWluKTtcblxuXHRcdFx0Y29uc3QgSVNfT1VUID0gL19vdXQkLy50ZXN0KHBhdGhNYWluKTtcblxuXHRcdFx0Ly9jb25zb2xlLmxvZyhgW1RPQ10g5qqi5p+lICR7cGF0aE1haW59YCk7XG5cblx0XHRcdGxldCBib29sID0gZmFsc2U7XG5cblx0XHRcdGF3YWl0IFByb21pc2Vcblx0XHRcdFx0LnJlZHVjZShGYXN0R2xvYjxzdHJpbmc+KFtcblx0XHRcdFx0XHQnKi9SRUFETUUubWQnLFxuXHRcdFx0XHRdLCB7XG5cdFx0XHRcdFx0Y3dkLFxuXHRcdFx0XHR9KSwgZnVuY3Rpb24gKHJldDogSVJldCwgaXRlbSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJldHVybiBjcmVhdGVSZWFkbWVEYXRhKGN3ZCwgcmV0LCBpdGVtKTtcblx0XHRcdFx0fSwge30gYXMgSVJldClcblx0XHRcdFx0LnRhcChhc3luYyBmdW5jdGlvbiAocmV0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0aWYgKCFPYmplY3Qua2V5cyhyZXQpLmxlbmd0aClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmdyYXkoYFtUT0NdIOW/veeVpSAke3BhdGhNYWlufWApO1xuXHRcdFx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Ym9vbCA9IHRydWU7XG5cblx0XHRcdFx0XHRjb25zb2xlLmRlYnVnKGBbVE9DXSDomZXnkIYgJHtwYXRoTWFpbn1gKTtcblxuXHRcdFx0XHRcdHRvY19sc1twYXRoTWFpbl0gPSByZXQ7XG5cblx0XHRcdFx0XHRyZXQgPSBPYmplY3Qua2V5cyhyZXQpXG5cdFx0XHRcdFx0XHQuc29ydCgpXG5cdFx0XHRcdFx0XHQucmVkdWNlKGZ1bmN0aW9uIChhLCBpdGVtX2lkKVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRsZXQgaXRlbSA9IHJldFtpdGVtX2lkXTtcblxuXHRcdFx0XHRcdFx0XHRpdGVtLmxpbmsgPSBgWyR7aXRlbV9pZH1dKCR7bWRfaHJlZihpdGVtX2lkKX0vKWA7XG5cblx0XHRcdFx0XHRcdFx0bGV0IHRhcmdldF9pZCA9IElTX09VVCA/IHBhdGhNYWluLnJlcGxhY2UoL19vdXQkLywgJycpIDogcGF0aE1haW4gKyAnX291dCc7XG5cblx0XHRcdFx0XHRcdFx0bGV0IGxpbmtfcGF0aCA9IHBhdGguam9pbihESVNUX05PVkVMX1JPT1QsIHRhcmdldF9pZCwgaXRlbV9pZCk7XG5cblx0XHRcdFx0XHRcdFx0Ly9jb25zb2xlLmxvZyhsaW5rX3BhdGgsIGZzLmV4aXN0c1N5bmMobGlua19wYXRoKSk7XG5cblx0XHRcdFx0XHRcdFx0aWYgKGZzLmV4aXN0c1N5bmMobGlua19wYXRoKSlcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdGl0ZW1bSVNfT1VUXG5cdFx0XHRcdFx0XHRcdFx0XHQ/ICdsaW5rX3NvdXJjZSdcblx0XHRcdFx0XHRcdFx0XHRcdDogJ2xpbmtfb3V0cHV0J10gPSBgWyR7aXRlbV9pZH1dKC4uLyR7dGFyZ2V0X2lkfS8ke21kX2hyZWYoaXRlbV9pZCl9LylgO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aWYgKEFycmF5LmlzQXJyYXkoaXRlbS50aXRsZXMpKVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0aXRlbS50aXRsZXMgPSBhcnJheV91bmlxdWUoaXRlbS50aXRsZXMpXG5cdFx0XHRcdFx0XHRcdFx0XHQuZmlsdGVyKHYgPT4gdilcblx0XHRcdFx0XHRcdFx0XHQ7XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRpZiAoQXJyYXkuaXNBcnJheShpdGVtLnRhZ3MpKVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0aXRlbS50YWdzID0gYXJyYXlfdW5pcXVlKGl0ZW0udGFncylcblx0XHRcdFx0XHRcdFx0XHRcdC5maWx0ZXIodiA9PiB2KVxuXHRcdFx0XHRcdFx0XHRcdDtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmICghaXRlbS50aXRsZXMpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRkZWxldGUgaXRlbS50aXRsZXM7XG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0ZWxzZSBpZiAoaXRlbS50aXRsZXMubGVuZ3RoID09IDEpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0XHRcdFx0aXRlbS50aXRsZXMgPSBpdGVtLnRpdGxlc1swXTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGlmIChpdGVtLnRhZ3MpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0XHRcdFx0aXRlbS50YWdzID0gaXRlbS50YWdzLmpvaW4oJyAsICcpO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0c29ydE9iamVjdEtleXMoaXRlbSwge1xuXHRcdFx0XHRcdFx0XHRcdHVzZVNvdXJjZTogdHJ1ZSxcblx0XHRcdFx0XHRcdFx0XHRrZXlzOiBbXG5cdFx0XHRcdFx0XHRcdFx0XHQnbGluaycsXG5cdFx0XHRcdFx0XHRcdFx0XHQnbGlua19vdXRwdXQnLFxuXHRcdFx0XHRcdFx0XHRcdFx0J2xpbmtfc291cmNlJyxcblx0XHRcdFx0XHRcdFx0XHRcdCd0aXRsZXMnLFxuXHRcdFx0XHRcdFx0XHRcdFx0J3RhZ3MnLFxuXHRcdFx0XHRcdFx0XHRcdF0sXG5cdFx0XHRcdFx0XHRcdH0pO1xuXG5cdFx0XHRcdFx0XHRcdGFbaXRlbV9pZF0gPSBpdGVtO1xuXG5cdFx0XHRcdFx0XHRcdHJldHVybiBhO1xuXHRcdFx0XHRcdFx0fSwge30pXG5cdFx0XHRcdFx0O1xuXG5cdFx0XHRcdFx0bGV0IG1kID0gbWRjb25mLnN0cmluZ2lmeSh7XG5cdFx0XHRcdFx0XHR0b2M6IHJldCxcblx0XHRcdFx0XHR9KTtcblxuXHRcdFx0XHRcdC8vY29uc29sZS5sb2cocGF0aE1haW4sIHJldCk7XG5cdFx0XHRcdFx0Ly9jb25zb2xlLmxvZyhtZCk7XG5cblx0XHRcdFx0XHRhd2FpdCBmcy53cml0ZUZpbGUocGF0aC5qb2luKGN3ZCwgJ1JFQURNRS5tZCcpLCBtZCk7XG5cdFx0XHRcdH0pXG5cdFx0XHRcdDtcblxuXHRcdFx0cmV0dXJuIHRvY19scztcblx0XHR9LCB7fSBhcyB7XG5cdFx0XHRbazogc3RyaW5nXTogSVJldCxcblx0XHR9KVxuXHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHR7XG5cdFx0XHRjb25zb2xlLmRlYnVnKGBbVE9DXSDntZDmnZ/lu7rnq4sgdG9jIOWIl+ihqGApO1xuXHRcdH0pXG5cdFx0O1xuXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVJldFJvd1xue1xuXHR0aXRsZXM6IHN0cmluZ1tdLFxuXHR0YWdzPzogc3RyaW5nW10sXG5cblx0bGluaz86IHN0cmluZyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJUmV0XG57XG5cdFtrOiBzdHJpbmddOiBJUmV0Um93XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZWFkbWVEYXRhKGN3ZDogc3RyaW5nLCByZXQ6IElSZXQsIGl0ZW06IHN0cmluZyk6IFByb21pc2U8SVJldD5cbi8vIEB0cy1pZ25vcmVcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVSZWFkbWVEYXRhKGN3ZDogc3RyaW5nLCByZXQ6IElSZXQsIGl0ZW06IHN0cmluZyk6IFByb21pc2U8SVJldD5cbntcblx0bGV0IGl0ZW1faWQgPSBwYXRoLmJhc2VuYW1lKHBhdGguZGlybmFtZShpdGVtKSk7XG5cblx0bGV0IG1ldGFfZmlsZSA9IHBhdGguam9pbihjd2QsIGl0ZW0pO1xuXG5cdGxldCBtZXRhOiBJTWRjb25mTWV0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKG1ldGFfZmlsZSlcblx0XHQudGhlbihtZGNvbmZfcGFyc2UpXG5cdFx0LmNhdGNoKGZ1bmN0aW9uIChlcnIpXG5cdFx0e1xuXHRcdFx0Y29uc29sZS5lcnJvcihlcnIudG9TdHJpbmcoKSk7XG5cblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH0pXG5cdDtcblxuXHRyZXRbaXRlbV9pZF0gPSB7XG5cdFx0dGl0bGVzOiBbXSxcblx0XHR0YWdzOiBbXSxcblx0fTtcblxuXHR7XG5cdFx0bGV0IHRpdGxlcyA9IFtdIGFzIHN0cmluZ1tdO1xuXG5cdFx0dGl0bGVzLnB1c2goaXRlbV9pZCk7XG5cblx0XHRpZiAobWV0YSlcblx0XHR7XG5cdFx0XHR0aXRsZXMucHVzaChtZXRhLm5vdmVsLnRpdGxlKTtcblx0XHRcdHRpdGxlcy5wdXNoKG1ldGEubm92ZWwudGl0bGVfemgpO1xuXHRcdFx0dGl0bGVzLnB1c2gobWV0YS5ub3ZlbC50aXRsZV9qcCk7XG5cdFx0XHR0aXRsZXMucHVzaChtZXRhLm5vdmVsLnRpdGxlX2VuKTtcblx0XHRcdHRpdGxlcy5wdXNoKG1ldGEubm92ZWwudGl0bGVfc2hvcnQpO1xuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0dGl0bGVzLnB1c2gobWV0YS5ub3ZlbC50aXRsZV90dyk7XG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHR0aXRsZXMucHVzaChtZXRhLm5vdmVsLnRpdGxlX2NuKTtcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdHRpdGxlcy5wdXNoKG1ldGEubm92ZWwudGl0bGVfc291cmNlKTtcblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdHRpdGxlcy5wdXNoKG1ldGEubm92ZWwudGl0bGVfb3RoZXIpO1xuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0dGl0bGVzLnB1c2gobWV0YS5ub3ZlbC50aXRsZV9vdXRwdXQpO1xuXG5cdFx0XHRpZiAobWV0YS5ub3ZlbC5zZXJpZXMpXG5cdFx0XHR7XG5cdFx0XHRcdHRpdGxlcy5wdXNoKG1ldGEubm92ZWwuc2VyaWVzLm5hbWUpO1xuXHRcdFx0XHR0aXRsZXMucHVzaChtZXRhLm5vdmVsLnNlcmllcy5uYW1lX3Nob3J0KTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKG1ldGEubm92ZWwuYXV0aG9yKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXRbaXRlbV9pZF0udGFncy5wdXNoKG1ldGEubm92ZWwuYXV0aG9yKVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHRpdGxlcyA9IGFycmF5X3VuaXF1ZSh0aXRsZXMuZmlsdGVyKHYgPT4gdikpO1xuXG5cdFx0aWYgKHRpdGxlcy5sZW5ndGggPT0gMSAmJiB0aXRsZXNbMF0gPT0gaXRlbV9pZClcblx0XHR7XG5cdFx0XHR0aXRsZXMgPSBudWxsO1xuXHRcdH1cblxuXHRcdHJldFtpdGVtX2lkXS50aXRsZXMgPSB0aXRsZXM7XG5cdH1cblxuXHRpZiAobWV0YSAmJiBtZXRhLm5vdmVsLnRhZ3MpXG5cdHtcblx0XHRyZXRbaXRlbV9pZF0udGFncyA9IHJldFtpdGVtX2lkXS50YWdzXG5cdFx0XHQuY29uY2F0KE9iamVjdC52YWx1ZXMobWV0YS5ub3ZlbC50YWdzKSlcblx0XHQ7XG5cdH1cblxuXHRyZXR1cm4gcmV0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVmYXVsdEZpbHRlcih2YWx1ZTogc3RyaW5nKTogYm9vbGVhblxue1xuXHRyZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgc2VsZlxuIl19